<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diário de Obras - Sistema Completo</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/highcharts-3d.js"></script>
    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --primary: #2563EB;
            --primary-light: #EFF6FF;
            --secondary: #64748B;
            --accent: #0D9488;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg-body: #F1F5F9;
            --bg-sidebar: #FFFFFF;
            --card-shadow: 0 4px 15px rgba(0,0,0,0.05);
            --text-main: #1E293B;
            --border-radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; border: 2px solid #f1f1f1; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .scrollable-box {
            max-height: 450px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
            border: 1px solid #F1F5F9;
            border-radius: 8px;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 280px;
            background-color: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            border-right: 1px solid #E2E8F0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
        }

        #sidebar.collapsed { width: 90px; }

        .sidebar-header {
            padding: 25px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 800;
            flex-shrink: 0;
        }

        /* Mobile Header */
        #mobile-header {
            display: none;
            position: fixed; top: 0; left: 0; right: 0;
            height: 60px; background: white;
            z-index: 90;
            padding: 0 20px;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .toggle-btn {
            background: var(--primary-light);
            border: none; color: var(--primary);
            width: 40px; height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        #mobile-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 99;
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        #mobile-backdrop.active { display: block; opacity: 1; }

        .menu-box {
            margin: 10px 16px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            border: 1px solid #F1F5F9;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .category-title {
            padding: 16px; cursor: pointer; font-weight: 600;
            color: var(--text-main); display: flex; align-items: center; gap: 12px;
            user-select: none;
        }
        
        .icon-box {
            width: 36px; height: 36px;
            background: var(--primary-light); color: var(--primary);
            border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }

        #admin-menu-box { border-left: 4px solid var(--danger); }
        #admin-menu-box .icon-box { background: #FEF2F2; color: var(--danger); }

        .subcategory-list { background-color: #FAFAFA; max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .subcategory-list.open { max-height: 300px; border-top: 1px solid #F1F5F9; }

        .subcategory-item {
            padding: 14px 16px 14px 64px;
            font-size: 0.9rem; color: var(--secondary); cursor: pointer;
        }
        .subcategory-item:hover { color: var(--primary); font-weight: 600; }

        /* Sidebar Collapsed State */
        #sidebar.collapsed .text-label, #sidebar.collapsed .subcategory-list, #sidebar.collapsed .arrow { display: none; }
        #sidebar.collapsed .menu-box { margin: 12px 10px; padding: 10px 0; box-shadow: none; background: transparent; display: flex; justify-content: center; }
        #sidebar.collapsed .category-title { padding: 0; justify-content: center; }
        #sidebar.collapsed .sidebar-header span:first-child { display: none; }

        /* --- MAIN CONTENT --- */
        #main-content {
            flex: 1; padding: 40px; 
            overflow-y: auto; overflow-x: hidden;
            padding-top: 40px;
        }
        
        .card-panel {
            background: white; padding: 25px; border-radius: 20px;
            box-shadow: var(--card-shadow); margin-bottom: 20px;
            border: 1px solid #F8FAFC;
        }

        /* Inputs & Buttons */
        input, select, textarea {
            width: 100%; padding: 14px; margin-bottom: 15px;
            border: 1px solid #E2E8F0; border-radius: 12px;
            background: #F8FAFC; outline: none; font-size: 16px; font-family: inherit;
        }
        
        textarea { resize: vertical; min-height: 100px; }
        
        button {
            width: 100%; padding: 14px;
            background-color: var(--primary); color: white;
            border: none; border-radius: 12px; font-weight: 600;
            cursor: pointer; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
            font-size: 1rem;
        }
        
        .btn-danger { background-color: #FFF1F2; color: var(--danger); box-shadow: none; }

        /* Tables */
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .user-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 700px; }
        .user-table th { text-align: left; padding: 15px; color: var(--secondary); font-size: 0.85rem; border-bottom: 2px solid #F1F5F9; position: sticky; top: 0; background: white; z-index: 10; }
        .user-table td { padding: 15px; border-bottom: 1px solid #F1F5F9; vertical-align: middle; }
        
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; white-space: nowrap; }
        .badge-active { background: #DCFCE7; color: #16A34A; }
        .badge-planning { background: #FEF3C7; color: #D97706; }
        .badge-done { background: #E2E8F0; color: #475569; }
        .badge-danger { background: #FEE2E2; color: #DC2626; border: 1px solid #FECACA; }

        /* Action Buttons */
        .action-group { display: flex; gap: 8px; }
        .btn-icon { padding: 0; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; border: none; display: flex; align-items: center; justify-content: center; }
        .btn-view { background: #F1F5F9; color: var(--secondary); }
        .btn-edit { background: #FFF7ED; color: var(--warning); }
        .btn-delete { background: #FEF2F2; color: var(--danger); }
        .btn-whatsapp { background: #DCFCE7; color: #16A34A; text-decoration: none; }
        .btn-perm { background: #E0E7FF; color: #3730A3; }
        .btn-print { background: #F3E8FF; color: #7E22CE; }

        /* TABS */
        .tab-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; background: #F1F5F9; color: var(--secondary); }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }

        /* Grid Layouts */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .backup-btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn-backup, .btn-restore, .btn-reset { flex: 1; min-width: 120px; }
        .btn-restore { background-color: var(--accent); }
        .btn-reset { background-color: var(--danger); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .stat-card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--card-shadow); display: flex; justify-content: space-between; align-items: center; }

        /* Switches & Overlays */
        .permission-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #F1F5F9; }
        .switch { position: relative; display: inline-block; width: 44px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* UPGRADE VISUAL: ÁREA DE SELEÇÃO MODERNA (GESTÃO) */
        .modern-select-box {
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 12px;
            min-height: 100px;
            max-height: 160px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-content: flex-start;
        }
        .selection-chip {
            padding: 8px 14px;
            background: white;
            border: 1px solid #CBD5E1;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            color: var(--secondary);
            font-weight: 500;
        }
        .selection-chip:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-1px); }
        .selection-chip.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 3px 6px rgba(37, 99, 235, 0.25);
        }
        .section-label { font-size: 0.85rem; color: var(--secondary); margin-bottom: 8px; font-weight: 700; display: block; text-transform: uppercase; letter-spacing: 0.5px; }

        /* NOVO: OVERLAY DE TELA CHEIA E MODAL DE ARQUIVOS */
        #fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000;
            display: none; justify-content: center; align-items: center;
            flex-direction: column;
        }
        #fullscreen-content {
            max-width: 95%; max-height: 85%;
            border-radius: 8px; box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        #close-fullscreen {
            position: absolute; top: 20px; right: 20px;
            color: white; font-size: 40px; cursor: pointer;
            background: transparent; border: none; width: auto; box-shadow: none;
        }
        #fullscreen-caption {
            color: white; font-size: 1.2rem; margin-top: 15px;
            background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px;
            text-align: center; max-width: 80%;
        }

        #files-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2500;
            display: none; justify-content: center; align-items: center; padding: 20px;
        }
        .files-modal-content {
            background: white; width: 100%; max-width: 600px;
            border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            max-height: 80vh; display: flex; flex-direction: column;
        }
        .file-item-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border: 1px solid #E2E8F0; border-radius: 12px;
            margin-bottom: 10px; background: #F8FAFC;
        }
        .file-info { display: flex; flex-direction: column; gap: 4px; }
        .file-name { font-weight: 600; color: var(--text-main); }
        .file-desc { font-size: 0.8rem; color: var(--secondary); }

        /* ESTILOS CLIMA MODERNO */
        .modern-weather-widget {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            color: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
            position: relative;
            overflow: hidden;
            border: none;
        }
        .weather-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .weather-current { display: flex; align-items: center; gap: 20px; margin-top: 15px; margin-bottom: 25px; }
        .weather-temp-main { font-size: 3.5rem; font-weight: 800; line-height: 1; }
        .weather-datetime { font-size: 0.9rem; opacity: 0.9; margin-top: 4px; text-transform: capitalize; }
        .modern-weather-day {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 15px 12px;
            border-radius: 16px;
            text-align: center;
            min-width: 80px;
            color: white;
            transition: transform 0.2s;
        }
        .modern-weather-day:hover { transform: translateY(-3px); background: rgba(255, 255, 255, 0.25); }
        .modern-weather-day .day-name { font-size: 0.85rem; font-weight: 700; opacity: 0.9; letter-spacing: 0.5px; }
        .modern-weather-day .weather-icon { font-size: 28px; margin: 10px 0; }
        .modern-weather-day .temp-range { font-size: 0.95rem; font-weight: 700; }

        /* GALERIA DE OBRAS */
        .work-gallery-card {
            min-width: 220px;
            height: 150px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
            cursor: pointer;
            border: 1px solid #E2E8F0;
        }
        .work-gallery-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .work-gallery-card:hover .work-gallery-img {
            transform: scale(1.05);
        }
        .work-gallery-overlay {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 15px 12px;
            color: white;
        }
        .work-gallery-title {
            font-size: 0.95rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* HUD DASHBOARD 3D AZUL DEGRADÊ */
        .hud-dashboard {
            background: linear-gradient(135deg, #1E3A8A, #3B82F6);
            border: none;
            border-radius: 20px;
            padding: 20px;
            color: #FFF;
            font-family: 'Segoe UI', Courier, monospace;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .hud-top-row {
            display: flex; justify-content: space-around; padding: 20px 0; border: 1px solid rgba(255, 255, 255, 0.2); position: relative; background: rgba(255, 255, 255, 0.1); border-radius: 12px; flex-wrap: wrap; gap: 15px;
        }
        
        .hud-circle-wrap { display: flex; flex-direction: column; align-items: center; gap: 10px; min-width: 100px; flex: 1; }
        .hud-circle-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: #E0F2FE; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; max-width: 130px; font-weight: 600;}
        .hud-circle {
            width: 80px; height: 80px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: conic-gradient(#FFF var(--p), rgba(255,255,255,0.15) 0deg);
            position: relative;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
        .hud-circle::before { content: ''; position: absolute; width: 62px; height: 62px; background: #2563EB; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.3); }
        .hud-circle-val { position: relative; font-size: 1.1rem; font-weight: 700; color: #FFF; font-family: sans-serif; }

        .hud-mid-row { display: grid; grid-template-columns: 1fr; gap: 15px; } 
        .hud-chart-box { border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 12px; position: relative; background: rgba(255, 255, 255, 0.1); }
        
        .hud-bot-row { border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 15px; position: relative; background: rgba(255, 255, 255, 0.1); }
        .hud-h-bar-container { display: flex; flex-direction: column; gap: 12px; }
        .hud-h-bar-row { display: flex; align-items: center; gap: 10px; }
        .hud-h-bar-label { width: 120px; font-size: 0.75rem; color: #FFF; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;}
        .hud-h-bar-track { flex: 1; height: 4px; background: rgba(255,255,255,0.2); position: relative; display: flex; align-items: center; border-radius: 2px; }
        .hud-h-bar-fill { height: 100%; background: #FFF; border-radius: 2px; position: relative; transition: width 1s ease; }
        .hud-h-bar-dot { position: absolute; right: -5px; top: -3px; width: 10px; height: 10px; background: #FFF; border-radius: 50%; box-shadow: 0 0 5px rgba(255,255,255,0.8); }
        .hud-h-bar-val { font-size: 0.75rem; width: 70px; text-align: right; color: #FFF; font-weight:bold; }

        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 2000;
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }
        #login-overlay .card-panel { width: 100%; max-width: 400px; text-align: center; }

        .search-container { position: relative; margin-bottom: 15px; }
        .search-container input { padding-left: 45px; margin-bottom: 0; }
        .search-container .icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--secondary); }
        
        .log-action { font-weight: bold; color: var(--primary); }
        .log-time { color: var(--secondary); font-size: 0.85rem; }
        .form-section-title { font-size: 0.9rem; font-weight: 700; color: var(--secondary); margin: 15px 0 5px; text-transform: uppercase; border-bottom: 1px solid #E2E8F0; padding-bottom: 5px; }

        /* Chat Styles */
        .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-me { background-color: var(--primary-light); color: var(--text-main); align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-other { background-color: #E2E8F0; color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-meta { font-size: 0.7rem; margin-top: 4px; opacity: 0.7; text-align: right; }

        @media (max-width: 992px) {
            #mobile-header { display: flex; }
            #sidebar { position: fixed; top: 0; left: -280px; height: 100%; box-shadow: 5px 0 20px rgba(0,0,0,0.1); }
            #sidebar.mobile-open { left: 0; }
            #sidebar .sidebar-header .toggle-btn { display: none; } 
            #main-content { padding: 20px; padding-top: 80px; }
            .settings-grid { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
        
        /* Oculta marcas d'água da biblioteca Highcharts */
        .highcharts-credits { display: none !important; }
    </style>
</head>
<body>

    <div id="mobile-backdrop" onclick="toggleSidebar()"></div>

    <div id="fullscreen-overlay">
        <button id="close-fullscreen" onclick="document.getElementById('fullscreen-overlay').style.display='none'">&times;</button>
        <img id="fullscreen-content" src="" alt="Visualização">
        <p id="fullscreen-caption"></p>
    </div>

    <div id="files-modal">
        <div class="files-modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="color:var(--primary);">Arquivos do Projeto</h3>
                <button class="btn-icon" onclick="document.getElementById('files-modal').style.display='none'" style="width:30px; height:30px;"><span class="material-icons-round">close</span></button>
            </div>
            <div id="files-list-container" class="scrollable-box" style="flex:1;">
            </div>
        </div>
    </div>

    <div id="mobile-header">
        <div onclick="resetToDashboard()" style="display: flex; align-items: center; gap: 10px; font-weight: bold; color: var(--primary); font-size: 1.2rem; cursor: pointer;">
            <span class="material-icons-round">poll</span> DiNit
        </div>
        <button class="toggle-btn" onclick="toggleSidebar()">
            <span class="material-icons-round">menu</span>
        </button>
    </div>

    <div id="login-overlay">
        <div class="card-panel">
            <div style="width: 70px; height: 70px; background: var(--primary); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                <span class="material-icons-round" style="color: white; font-size: 35px;">apartment</span>
            </div>
            <h2>Bem-vindo</h2>
            <p style="color: var(--secondary); margin-bottom: 25px;">Insira suas credenciais</p>
            <input type="email" id="login-email" placeholder="E-mail">
            <input type="password" id="login-password" placeholder="Senha">
            <button onclick="handleLogin()" id="btn-login" style="margin-top: 10px;">Acessar Painel</button>
            <p id="login-msg" style="color: var(--danger); margin-top: 15px; min-height: 20px; font-weight: bold;"></p>
        </div>
    </div>

    <div id="sidebar">
        <div class="sidebar-header">
            <div onclick="resetToDashboard()" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <span class="material-icons-round" style="color: var(--primary);">poll</span>
                <span>DiNit</span>
            </div>
            <button class="toggle-btn" onclick="toggleSidebar()">
                <span class="material-icons-round">menu_open</span>
            </button>
        </div>

        <div class="menu-box" id="menu-tap">
            <div class="category-title" onclick="toggleSubmenu(this)">
                <div class="icon-box"><span class="material-icons-round">assignment_turned_in</span></div>
                <span class="text-label" style="flex:1">Termo de Abertura</span>
                <span class="material-icons-round arrow" style="color: #CBD5E1">expand_more</span>
            </div>
            <div class="subcategory-list">
                <div class="subcategory-item" id="menu-sub-termo-abertura" onclick="showTermoAberturaPanel()">Termo de Abertura (TAP)</div>
                <div class="subcategory-item" id="menu-sub-prof" onclick="showContractPanel()">Cadastro do Profissional</div>
                <div class="subcategory-item" id="menu-sub-contratante" onclick="showContratantePanel()">Cadastro de Contratante</div>
                <div class="subcategory-item" id="menu-sub-dados-obra" onclick="showTapPanel('DadosObra')">Dados da Obra/Serviço</div>
                <div class="subcategory-item" onclick="showTapPanel('Obs')">Observação</div>
            </div>
        </div>
        
        <div class="menu-box" id="menu-diaries">
            <div class="category-title" onclick="toggleSubmenu(this)">
                <div class="icon-box" style="color: var(--warning); background: #FFFBEB"><span class="material-icons-round">assignment</span></div>
                <span class="text-label" style="flex:1">Diários</span>
                <span class="material-icons-round arrow" style="color: #CBD5E1">expand_more</span>
            </div>
            <div class="subcategory-list">
                <div class="subcategory-item" id="menu-sub-relatorio-diario" onclick="showDiariesPanel()">Relatórios Diários</div>
                <div class="subcategory-item" id="menu-sub-nova-ocorrencia" onclick="showOccurrencesPanel()">Nova Ocorrência</div>
            </div>
        </div>

        <div class="menu-box" id="menu-management">
            <div class="category-title" onclick="toggleSubmenu(this)">
                <div class="icon-box" style="background: #E0E7FF; color: #3730A3;"><span class="material-icons-round">business</span></div>
                <span class="text-label" style="flex:1">Gestão de Obras</span>
                <span class="material-icons-round arrow" style="color: #CBD5E1">expand_more</span>
            </div>
            <div class="subcategory-list">
                <div class="subcategory-item" onclick="showManagementPanel()">Administração</div>
                <div class="subcategory-item" onclick="showUploadProjectPanel()">Upload de Projeto</div>
            </div>
        </div>

        <div class="menu-box" id="menu-query">
            <div class="category-title" onclick="toggleSubmenu(this)">
                <div class="icon-box" style="background: #F1F5F9; color: #1E293B;"><span class="material-icons-round">search</span></div>
                <span class="text-label" style="flex:1">Consulta de Projeto</span>
                <span class="material-icons-round arrow" style="color: #CBD5E1">expand_more</span>
            </div>
            <div class="subcategory-list">
                <div class="subcategory-item" onclick="showQueryPanel()">Visualizar Projetos</div>
            </div>
        </div>

        <div class="menu-box" id="menu-communication">
            <div class="category-title" onclick="toggleSubmenu(this)">
                <div class="icon-box" style="background: #E0E7FF; color: #4338CA;"><span class="material-icons-round">chat</span></div>
                <span class="text-label" style="flex:1">Comunicação</span>
                <span class="material-icons-round arrow" style="color: #CBD5E1">expand_more</span>
            </div>
            <div class="subcategory-list">
                <div class="subcategory-item" onclick="showCommunicationPanel()">Canal da Obra</div>
            </div>
        </div>

        <div class="menu-box" id="menu-employees">
            <div class="category-title" onclick="toggleSubmenu(this)">
                <div class="icon-box" style="background: #D1FAE5; color: #059669;"><span class="material-icons-round">groups</span></div>
                <span class="text-label" style="flex:1">Funcionários</span>
                <span class="material-icons-round arrow" style="color: #CBD5E1">expand_more</span>
            </div>
            <div class="subcategory-list">
                <div class="subcategory-item" onclick="showEmployeesPanel()">Cadastro e Alocação</div>
            </div>
        </div>

        <div class="menu-box" id="menu-warehouse">
            <div class="category-title" onclick="toggleSubmenu(this)">
                <div class="icon-box" style="background: #FEF3C7; color: #D97706;"><span class="material-icons-round">inventory_2</span></div>
                <span class="text-label" style="flex:1">Almoxarifado</span>
                <span class="material-icons-round arrow" style="color: #CBD5E1">expand_more</span>
            </div>
            <div class="subcategory-list">
                <div class="subcategory-item" onclick="showWarehousePanel()">Controle de Estoque</div>
            </div>
        </div>

        <div class="menu-box" id="admin-menu-box" style="display: none;">
            <div class="category-title" onclick="toggleSubmenu(this)">
                <div class="icon-box"><span class="material-icons-round">admin_panel_settings</span></div>
                <span class="text-label" style="flex:1">Admin</span>
                <span class="material-icons-round arrow" style="color: #CBD5E1">expand_more</span>
            </div>
            <div class="subcategory-list">
                <div class="subcategory-item" onclick="showAdminPanel()">Gerenciar Usuários</div>
                <div class="subcategory-item" onclick="showSettingsPanel()">Configurações (D.S.P)</div>
                <div class="subcategory-item" onclick="showAuditPanel()">Auditoria de Logs</div>
            </div>
        </div>
        
        <div style="margin-top: auto; padding: 20px;">
            <button onclick="handleLogout()" class="btn-danger">
                <span class="text-label">Sair</span>
                <span class="material-icons-round" style="display:none;">logout</span>
            </button>
        </div>
    </div>

    <div id="main-content">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div>
                <h1 id="page-title" style="font-size: 1.5rem;">Dashboard</h1>
                <p style="color: var(--secondary)">Visão Geral</p>
            </div>
            <div style="text-align: right; display: flex; align-items: center; gap: 10px;">
                <div style="text-align: right;">
                    <p id="user-name-display" style="font-weight: 700; font-size: 0.9rem;">...</p>
                    <p id="user-role-display" style="font-size: 0.75rem; color: var(--secondary);">...</p>
                </div>
                <div style="width: 40px; height: 40px; background: #E2E8F0; border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <span class="material-icons-round" style="color: var(--secondary)">person</span>
                </div>
            </div>
        </header>

        <div id="termo-abertura-panel" style="display: none;">
            <div class="card-panel" id="form-termo-card">
                <h3 style="color: var(--primary); margin-bottom: 15px;">Termo de Abertura (TAP)</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="text" id="t-nome-projeto" placeholder="Nome do Projeto">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="t-gerente" placeholder="Gerente do Projeto">
                        <input type="text" id="t-sponsor" placeholder="Patrocinador (Sponsor)">
                    </div>
                    
                    <textarea id="t-justificativa" placeholder="Justificativa do Projeto" style="height: 60px;"></textarea>
                    <textarea id="t-objetivos" placeholder="Objetivos do Projeto" style="height: 60px;"></textarea>
                    <textarea id="t-premissas" placeholder="Premissas e Restrições" style="height: 60px;"></textarea>
                    <input type="text" id="t-stakeholders" placeholder="Principais Stakeholders">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="t-orcamento" placeholder="Estimativa de Orçamento (R$)" oninput="formatCurrency(this)">
                        <input type="number" id="t-prazo" placeholder="Estimativa de Prazo (Meses)">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="handleSaveTermoAbertura()" id="btn-save-termo">Salvar</button>
                        <button onclick="cancelEditTermoAbertura()" id="btn-cancel-termo" style="background: var(--secondary); display: none; width: auto;">Cancelar</button>
                    </div>
                </div>
            </div>
            <div class="card-panel" id="list-termo-card">
                <h3 style="margin-bottom: 15px;">TAPs Cadastrados</h3>
                <div class="table-responsive scrollable-box">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Nome do Projeto</th>
                                <th>Gerente</th>
                                <th>Prazo (Meses)</th>
                                <th>Orçamento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="termo-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="contract-panel" style="display: none;">
            <div class="card-panel" id="form-contract-card">
                <h3 style="color: var(--primary); margin-bottom: 15px;">Cadastro do Profissional</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="text" id="cp-nome" placeholder="NOME DO PROFISSIONAL">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="cp-titulo" placeholder="TÍTULO">
                        <input type="text" id="cp-crea" placeholder="Nº DO CREA-UF \ VISTO">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="cp-rg" placeholder="Nº DO RG">
                        <input type="text" id="cp-cpf" placeholder="Nº DO CPF">
                    </div>
                    
                    <input type="text" id="cp-endereco" placeholder="ENDEREÇO">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" id="cp-bairro" placeholder="BAIRRO">
                        <input type="text" id="cp-cidade" placeholder="CIDADE">
                        <input type="text" id="cp-uf" placeholder="UF">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" id="cp-cep" placeholder="CEP">
                        <input type="text" id="cp-fone" placeholder="FONE">
                        <input type="text" id="cp-celular" placeholder="CELULAR">
                    </div>
                    
                    <input type="email" id="cp-email" placeholder="E-MAIL">
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="handleSaveContract()" id="btn-save-cp">Salvar</button>
                        <button onclick="cancelEditContract()" id="btn-cancel-cp" style="background: var(--secondary); display: none; width: auto;">Cancelar</button>
                    </div>
                </div>
            </div>
            <div class="card-panel" id="list-contract-card">
                <h3 style="margin-bottom: 15px;">Profissionais Cadastrados</h3>
                <div class="table-responsive scrollable-box">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Título</th>
                                <th>CREA / Visto</th>
                                <th>Celular</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="contract-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="contratante-panel" style="display: none;">
            <div class="card-panel" id="form-contratante-card">
                <h3 style="color: var(--primary); margin-bottom: 15px;">Cadastro de Contratante</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="text" id="ct-nome" placeholder="NOME DO CONTRATANTE">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="ct-rg" placeholder="Nº DO RG/IE">
                        <input type="text" id="ct-cpf" placeholder="Nº DO CPF/CNPJ">
                    </div>
                    
                    <input type="text" id="ct-endereco" placeholder="ENDEREÇO">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" id="ct-bairro" placeholder="BAIRRO">
                        <input type="text" id="ct-cidade" placeholder="CIDADE">
                        <input type="text" id="ct-uf" placeholder="UF">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <input type="text" id="ct-cep" placeholder="CEP">
                        <input type="text" id="ct-fone" placeholder="FONE">
                        <input type="text" id="ct-celular" placeholder="CELULAR">
                    </div>
                    
                    <input type="email" id="ct-email" placeholder="E-MAIL">
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="handleSaveContratante()" id="btn-save-ct">Salvar</button>
                        <button onclick="cancelEditContratante()" id="btn-cancel-ct" style="background: var(--secondary); display: none; width: auto;">Cancelar</button>
                    </div>
                </div>
            </div>
            <div class="card-panel" id="list-contratante-card">
                <h3 style="margin-bottom: 15px;">Contratantes Cadastrados</h3>
                <div class="table-responsive scrollable-box">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF/CNPJ</th>
                                <th>Celular</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="contratante-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="upload-project-panel" style="display: none;">
            <div class="card-panel">
                <h3 style="color: #3730A3; margin-bottom: 15px;">Upload de Arquivos de Projeto</h3>
                <div style="display: grid; gap: 15px;">
                    <label style="font-size: 0.9rem; color: var(--secondary);">Selecione a Obra (Cadastrada na Gestão):</label>
                    <select id="upload-project-select"><option value="">Selecione a Obra...</option></select>
                    
                    <label style="font-size: 0.9rem; color: var(--secondary);">Selecione o Arquivo (JPEG, PNG, PDF):</label>
                    <div style="position: relative; margin-bottom: 15px;">
                        <input type="file" id="project-file-input" accept="image/jpeg, image/png, application/pdf" style="width: 100%; padding: 10px; background: white; border: 1px dashed var(--primary); border-radius: 12px; cursor: pointer;">
                    </div>
                    
                    <input type="text" id="project-file-desc" placeholder="Nome/Descrição do arquivo (ex: Planta Baixa Pav. 1)">
                    
                    <button id="btn-upload-file" onclick="handleUploadProjectFile()">Enviar Arquivo</button>
                </div>
            </div>
        </div>

        <div id="query-panel" style="display: none;">
            <div class="card-panel">
                <h3 style="color: var(--text-main); margin-bottom: 15px;">Consultar Detalhes do Projeto</h3>
                <div class="search-container">
                    <span class="material-icons-round icon">search</span>
                    <input type="text" id="project-query-search" onkeyup="filterProjectQuery()" placeholder="Buscar por nome da obra ou cliente...">
                </div>
                <div class="table-responsive scrollable-box">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Projeto</th>
                                <th>Tipo</th>
                                <th>Cliente</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="query-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tap-panel" style="display: none;">
            <div class="card-panel" id="form-tap-card">
                <h3 style="color: var(--primary); margin-bottom: 15px;">Dados da Obra/Serviço</h3>
                <div id="tap-form-container">
                    <input type="text" id="tap-name" placeholder="Nome da Obra (Obrigatório)" style="font-weight: bold;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <select id="tap-type">
                            <option value="Residencial">Residencial</option>
                            <option value="Comercial">Comercial</option>
                            <option value="Industrial">Industrial</option>
                        </select>
                        <select id="tap-status">
                            <option value="Planejamento">Planejamento</option>
                            <option value="Em Andamento">Em Andamento</option>
                            <option value="Concluído">Concluído</option>
                        </select>
                    </div>
                    <div class="form-section-title">Resumo do Contrato (TAP)</div>
                    <input type="text" id="tap-contract-id" placeholder="Nº do Contrato">
                    <input type="text" id="tap-contract-value" placeholder="Valor Estimado">
                    <div class="form-section-title">Cadastro do Contratante</div>
                    <input type="text" id="tap-client-name" placeholder="Nome do Cliente/Empresa">
                    <input type="text" id="tap-client-contact" placeholder="Contato (Tel/Email)">
                    <div class="form-section-title">Detalhes do TAP</div>
                    <textarea id="tap-description" placeholder="Objetivos, Escopo e Justificativa do Projeto..." style="height: 80px;"></textarea>
                    <div class="form-section-title">Observação - Obra ou Serviço</div>
                    <textarea id="tap-obs" placeholder="Observações gerais..." style="height: 60px;"></textarea>
                </div>
                <button onclick="handleSaveTAP()" style="margin-top: 15px;">Salvar Termo de Abertura</button>
            </div>
            <div class="card-panel" id="list-tap-card">
                <h3 style="margin-bottom: 15px;">Obras Cadastradas (TAP)</h3>
                <div class="table-responsive scrollable-box">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Obra</th>
                                <th>Cliente</th>
                                <th>Status</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="tap-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="diaries-panel" style="display: none;">
            <div class="card-panel" id="form-diaries-card">
                <h3 style="color: var(--warning); margin-bottom: 15px;">Novo Relatório Diário</h3>
                <div style="display:grid; gap:15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <input type="date" id="report-date" style="margin-bottom:0;">
                        <select id="report-project-select" style="margin-bottom:0;"><option value="">Selecione a Obra...</option></select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <input type="text" id="report-photo" placeholder="URL da Foto (https://...)" style="margin-bottom:0;">
                        <input type="text" id="report-obs" placeholder="Observações Extras" style="margin-bottom:0;">
                    </div>
                    
                    <textarea id="report-desc" placeholder="Descreva as atividades, clima e ocorrências do dia..." style="min-height: 120px;"></textarea>
                    
                    <button onclick="handleSaveDiary()">Registrar Diário</button>
                </div>
            </div>
            <div class="card-panel" id="list-diaries-card">
                <h3 style="margin-bottom: 15px;">Histórico de Relatórios</h3>
                <div class="table-responsive scrollable-box"><table class="user-table"><thead><tr><th>Data</th><th>Obra</th><th>Autor</th><th>Resumo</th><th>Ação</th></tr></thead><tbody id="diaries-list-body"></tbody></table></div>
            </div>
        </div>

        <div id="occurrences-panel" style="display: none;">
            <div class="card-panel" id="form-occ-card">
                <h3 style="color: var(--danger); margin-bottom: 15px;">Registrar Nova Ocorrência</h3>
                <div style="display:grid; gap:15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-size: 0.9rem; color: var(--secondary);">Data da Ocorrência:</label>
                            <input type="date" id="occ-date" style="margin-bottom:0;">
                        </div>
                        <div>
                            <label style="font-size: 0.9rem; color: var(--secondary);">Selecione a Obra (Gestão):</label>
                            <select id="occ-project-select" style="margin-bottom:0;"><option value="">Selecione a Obra...</option></select>
                        </div>
                    </div>
                    
                    <div>
                        <label style="font-size: 0.9rem; color: var(--secondary);">Fotografar Ocorrência (Câmera):</label>
                        <input type="file" id="occ-photo" accept="image/*" capture="environment" style="padding: 10px; background: white; border: 1px dashed var(--danger); border-radius: 12px; width: 100%; cursor: pointer;">
                    </div>
                    
                    <div>
                        <label style="font-size: 0.9rem; color: var(--secondary);">Observação:</label>
                        <textarea id="occ-obs" placeholder="Descreva os detalhes da ocorrência..." style="min-height: 120px;"></textarea>
                    </div>
                    
                    <button id="btn-save-occ" onclick="handleSaveOccurrence()" style="background-color: var(--danger);">Registrar Ocorrência</button>
                </div>
            </div>
            <div class="card-panel" id="list-occ-card">
                <h3 style="margin-bottom: 15px;">Histórico de Ocorrências</h3>
                <div class="table-responsive scrollable-box">
                    <table class="user-table">
                        <thead><tr><th>Data</th><th>Obra</th><th>Autor</th><th>Observação</th><th>Ação</th></tr></thead>
                        <tbody id="occurrences-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="management-panel" style="display: none;">
            <div class="card-panel">
                <h3 style="color: #3730A3; margin-bottom: 15px;">Cadastrar/Editar Detalhes da Obra</h3>
                <div id="management-form-container" style="display: grid; gap: 15px;">
                    <input type="text" id="mgmt-name" placeholder="Nome da Obra">
                    
                    <div>
                        <label style="font-size: 0.9rem; color: var(--secondary);">Foto de Destaque (Max 800KB):</label>
                        <input type="file" id="mgmt-photo-input" accept="image/*" style="padding: 10px; background: white; border: 1px dashed var(--primary); border-radius: 12px; width: 100%;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="section-label">Engenheiros Responsáveis</label>
                            <div id="mgmt-engineers-box" class="modern-select-box">Carregando...</div>
                        </div>
                        <div>
                            <label class="section-label">Fiscais Responsáveis</label>
                            <div id="mgmt-fiscals-box" class="modern-select-box">Carregando...</div>
                        </div>
                        <div>
                            <label class="section-label">Arquitetos Responsáveis</label>
                            <div id="mgmt-architects-box" class="modern-select-box">Carregando...</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="mgmt-permit" placeholder="Nº Alvará">
                        <input type="text" id="mgmt-license" placeholder="Licença Ambiental">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="mgmt-val-contract" placeholder="Valor Contratado (R$)" oninput="formatCurrency(this)">
                        <input type="text" id="mgmt-val-measured" placeholder="Valor Medido (R$)" oninput="formatCurrency(this)">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.9rem; color: var(--secondary);">Início da Obra:</label>
                            <input type="date" id="mgmt-start-date" style="margin-bottom:0;">
                        </div>
                        <div>
                            <label style="font-size: 0.9rem; color: var(--secondary);">Término da Obra:</label>
                            <input type="date" id="mgmt-end-date" style="margin-bottom:0;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="handleSaveManagementWork()" id="btn-save-mgmt">Salvar Detalhes</button>
                        <button onclick="cancelEditManagementWork()" id="btn-cancel-mgmt" style="background: var(--secondary); display: none; width: auto;">Cancelar</button>
                    </div>
                </div>
            </div>
            <div class="card-panel" id="list-mgmt-card">
                <h3 style="margin-bottom: 15px;">Obras Gerenciadas</h3>
                <div class="table-responsive scrollable-box">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Obra</th>
                                <th>Datas</th>
                                <th>Engenheiros</th>
                                <th>Fiscais</th>
                                <th>Arquitetos</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="management-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="communication-panel" style="display: none;">
            <div class="card-panel" style="height: calc(100vh - 140px); display: flex; flex-direction: column;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">Canal de Comunicação Obra</h3>
                <select id="chat-project-select" onchange="loadProjectChat()" style="margin-bottom: 15px;"><option value="">Selecione a Obra...</option></select>
                <div id="chat-messages-area" class="scrollable-box" style="flex: 1; background: #F8FAFC; border-radius: 12px; padding: 20px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #E2E8F0; display: flex; flex-direction: column; gap: 10px;">
                    <p style="text-align: center; color: var(--secondary); margin-top: 50px;">Selecione uma obra acima para iniciar o chat.</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chat-input" placeholder="Digite sua mensagem..." style="margin-bottom: 0;">
                    <button onclick="sendMessage()" style="width: 60px; background: var(--primary); display: flex; align-items: center; justify-content: center;"><span class="material-icons-round">send</span></button>
                </div>
            </div>
        </div>

        <div id="employees-panel" style="display: none;">
            <div class="card-panel">
                <h3 style="color: #059669; margin-bottom: 15px;">Cadastro de Funcionário</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="text" id="emp-name" placeholder="Nome Completo">
                    <input type="text" id="emp-role" placeholder="Cargo / Função">
                    <label style="font-size: 0.9rem; color: var(--secondary);">Alocar em Obra (Apenas 'Em Andamento'):</label>
                    <select id="emp-project-select"><option value="">Selecione a Obra...</option></select>
                    <button onclick="handleSaveEmployee()" id="btn-save-employee">Cadastrar Funcionário</button>
                </div>
            </div>
            <div class="card-panel">
                <h3 style="margin-bottom: 15px;">Quadro de Funcionários</h3>
                <div class="table-responsive scrollable-box"><table class="user-table"><thead><tr><th>Nome</th><th>Cargo</th><th>Obra Alocada</th><th>Ação</th></tr></thead><tbody id="employees-list-body"></tbody></table></div>
            </div>
        </div>

        <div id="warehouse-panel" style="display: none;">
            
            <div id="wh-admin-controls" style="display:none; margin-bottom: 20px; border: 1px dashed var(--primary); padding: 15px; border-radius: 12px;">
                <h4 style="color:var(--primary); margin-bottom:10px;">Atribuir Almoxarife à Obra (Admin)</h4>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <select id="assign-wh-project" style="flex:1;"><option value="">Selecione Obra (Gestão)...</option></select>
                    <select id="assign-wh-user" style="flex:1;"><option value="">Selecione Almoxarife...</option></select>
                    <button onclick="assignWarehouseManager()" style="width: auto;">Vincular</button>
                </div>
                <div id="wh-assignments-list" style="margin-top:10px; font-size:0.9rem; color:var(--secondary);"></div>
            </div>

            <div id="wh-dashboard-stats" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">Visão Geral</h3>
                    <select id="wh-view-project" onchange="updateWarehouseDashboard()" style="width: 200px; padding: 8px; border-radius: 8px; border: 1px solid #E2E8F0;">
                        </select>
                </div>
                <div class="dashboard-grid">
                    <div class="stat-card"><div><p style="color:var(--secondary)">Total de Itens</p><h2 id="stat-total-items">0</h2></div><div class="icon-box" style="background:#E0E7FF; color:var(--primary)"><span class="material-icons-round">inventory_2</span></div></div>
                    <div class="stat-card"><div><p style="color:var(--danger)">Estoque Baixo</p><h2 id="stat-low-stock">0</h2></div><div class="icon-box" style="background:#FEE2E2; color:var(--danger)"><span class="material-icons-round">warning</span></div></div>
                    <div class="stat-card"><div><p style="color:var(--warning)">Empréstimos Ativos</p><h2 id="stat-active-loans">0</h2></div><div class="icon-box" style="background:#FEF3C7; color:var(--warning)"><span class="material-icons-round">assignment_return</span></div></div>
                </div>
            </div>

            <div class="tab-group">
                <button class="tab-btn active" onclick="switchWarehouseTab('stock')">Estoque</button>
                <button class="tab-btn" onclick="switchWarehouseTab('withdrawals')">Retiradas & Empréstimos</button>
            </div>

            <div id="view-stock">
                <div class="card-panel">
                    <h3 style="color: #D97706; margin-bottom: 15px;">Cadastro de Itens</h3>
                    <select id="wh-project-select" style="margin-bottom: 10px;"><option value="">Selecione a Obra de Destino...</option></select>
                    <div id="warehouse-form-container" style="display: grid; gap: 15px;">
                        <input type="text" id="wh-name" list="construction-items" placeholder="Nome do Item (Digite para sugestões)">
                        <datalist id="construction-items">
                            <option value="Martelo"></option>
                            <option value="Trena"></option>
                            <option value="Furadeira"></option>
                            <option value="Cimento"></option>
                            <option value="Areia"></option>
                            <option value="Capacete"></option>
                        </datalist>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <select id="wh-type"><option value="Ferramenta">Ferramenta</option><option value="Insumo">Insumo (Consumo)</option><option value="EPI">EPI</option><option value="Equipamento">Equipamento</option></select>
                            <select id="wh-category"><option value="Geral">Geral</option><option value="Manuais">Ferramentas Manuais</option><option value="Elétricas">Ferramentas Elétricas</option><option value="Materiais">Materiais de Construção</option></select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <input type="number" id="wh-qty" placeholder="Quantidade">
                            <select id="wh-unit"><option value="un">Unidade (un)</option><option value="kg">Quilos (kg)</option><option value="m">Metros (m)</option></select>
                        </div>
                        <button onclick="handleSaveInventory()">Adicionar ao Estoque</button>
                    </div>
                </div>
                <div class="card-panel"><h3 style="margin-bottom: 15px;">Ferramentas & Equipamentos</h3><div class="table-responsive scrollable-box"><table class="user-table"><thead><tr><th>Item/Obra</th><th>Categoria</th><th>Qtd.</th><th>Ação</th></tr></thead><tbody id="wh-list-tools"></tbody></table></div></div>
                <div class="card-panel"><h3 style="margin-bottom: 15px;">Materiais de Consumo & EPIs</h3><div class="table-responsive scrollable-box"><table class="user-table"><thead><tr><th>Item/Obra</th><th>Categoria</th><th>Qtd.</th><th>Ação</th></tr></thead><tbody id="wh-list-consumables"></tbody></table></div></div>
            </div>

            <div id="view-withdrawals" style="display: none;">
                <div class="card-panel">
                    <h3 style="color: #D97706; margin-bottom: 15px;">Registrar Retirada</h3>
                    <div style="display: grid; gap: 15px;">
                        <select id="wd-employee-select"><option value="">Selecione Funcionário...</option></select>
                        <select id="wd-item-select"><option value="">Selecione Item...</option></select>
                        <input type="number" id="wd-qty" placeholder="Quantidade a retirar">
                        <button onclick="handleWithdrawal()">Confirmar Retirada</button>
                    </div>
                </div>
                <div class="card-panel"><h3 style="margin-bottom: 15px;">Itens em Campo</h3><div class="table-responsive scrollable-box"><table class="user-table"><thead><tr><th>Funcionário</th><th>Item</th><th>Qtd.</th><th>Data</th><th>Ação</th></tr></thead><tbody id="wd-list-body"></tbody></table></div></div>
            </div>
        </div>

        <div id="admin-panel" style="display: none;">
            <div class="card-panel">
                <h3 id="form-title" style="color: var(--primary); margin-bottom: 20px;">Gestão de Usuários</h3>
                <div style="display: grid; gap: 15px;">
                    <input type="email" id="new-user-email" placeholder="E-mail">
                    <input type="tel" id="new-user-whatsapp" placeholder="WhatsApp (somente números)">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-user-pass" placeholder="Senha">
                        <select id="new-user-role">
                            <option value="user">Usuário Padrão</option>
                            <option value="admin">Administrador</option>
                            <option value="engenheiro">Eng. Civil</option>
                            <option value="gestor">Gestor</option>
                            <option value="almoxarifado">Almoxarife</option>
                            <option value="funcionario">Funcionário</option>
                            <option value="fiscal">Fiscal</option>
                            <option value="empreiteiro">Empreiteiro</option>
                            
                            <option value="eng_mecanico">Eng. Mecânico</option>
                            <option value="eng_eletrico">Eng. Elétrico</option>
                            <option value="eng_ambiental">Eng. Ambiental</option>
                            <option value="eng_estruturas">Eng. Estruturas/Calculista</option>
                            <option value="eng_geotecnico">Eng. Geotécnico</option>
                            <option value="eng_seguranca">Eng. Segurança do Trabalho</option>
                            <option value="eng_producao">Eng. Produção</option>
                            <option value="arquiteto">Arquiteto</option>
                            <option value="tec_edificacoes">Téc. Edificações/Construção</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="handleSaveUser()" id="btn-add-user">Criar Acesso</button>
                        <button onclick="cancelEdit()" id="btn-cancel-edit" style="background: var(--secondary); display: none; width: auto;">Cancelar</button>
                    </div>
                </div>
            </div>
            <div class="card-panel" style="padding: 15px;">
                <div class="search-container"><span class="material-icons-round icon">search</span><input type="text" id="user-search" onkeyup="filterUsers()" placeholder="Buscar usuário..."></div>
                <div class="table-responsive scrollable-box"><table class="user-table"><thead><tr><th>Usuário</th><th>WhatsApp</th><th>Senha</th><th>Cargo</th><th>Ações</th></tr></thead><tbody id="user-list-body"></tbody></table></div>
            </div>
        </div>

        <div id="settings-panel" style="display: none;">
            <div class="card-panel">
                <h3>D.S.P</h3> 
                <div class="backup-btn-group">
                    <button class="btn-backup" onclick="backupData()">Backup</button>
                    <button class="btn-restore" onclick="document.getElementById('file-input').click()">Restaurar</button>
                    <button class="btn-reset" onclick="resetData()">Resetar</button>
                    <input type="file" id="file-input" style="display: none;" onchange="restoreData(this)" accept=".json">
                </div>
            </div>
            <div class="card-panel">
                <h3>Permissões</h3>
                <p style="margin-bottom: 10px; font-size: 0.9rem;">Selecione um usuário para configurar seus acessos:</p>
                <select id="select-user-permission" onchange="loadUserPermissions()">
                    <option value="">Carregando...</option>
                </select>
                
                <div id="permissions-container" style="display: none; margin-top: 15px;">
                    <div class="permission-item"><span>Box Termo de Abertura (TAP)</span><label class="switch"><input type="checkbox" id="perm-tap"><span class="slider"></span></label></div>
                    
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem; border-bottom: none;"><span>&rdsh; Termo de Abertura (TAP)</span><label class="switch"><input type="checkbox" id="perm-sub-termo-abertura"><span class="slider"></span></label></div>
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem; border-bottom: none;"><span>&rdsh; Cadastro do Profissional</span><label class="switch"><input type="checkbox" id="perm-sub-prof"><span class="slider"></span></label></div>
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem; border-bottom: none;"><span>&rdsh; Cadastro de Contratante</span><label class="switch"><input type="checkbox" id="perm-sub-contratante"><span class="slider"></span></label></div>
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem;"><span>&rdsh; Dados da Obra/Serviço</span><label class="switch"><input type="checkbox" id="perm-sub-dados-obra"><span class="slider"></span></label></div>

                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem; border-bottom: none;"><span>&rdsh; TAPs Cadastrados</span><label class="switch"><input type="checkbox" id="perm-tap-list"><span class="slider"></span></label></div>
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem; border-bottom: none;"><span>&rdsh; Profissionais Cadastrados</span><label class="switch"><input type="checkbox" id="perm-prof-list"><span class="slider"></span></label></div>
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem; border-bottom: none;"><span>&rdsh; Contratantes Cadastrados</span><label class="switch"><input type="checkbox" id="perm-contractor-list"><span class="slider"></span></label></div>
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem;"><span>&rdsh; Obras Cadastradas (TAP)</span><label class="switch"><input type="checkbox" id="perm-works-list"><span class="slider"></span></label></div>

                    <div class="permission-item"><span>Box Diários</span><label class="switch"><input type="checkbox" id="perm-diaries"><span class="slider"></span></label></div>
                    
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem; border-bottom: none;"><span>&rdsh; Novo Relatório Diário</span><label class="switch"><input type="checkbox" id="perm-sub-relatorio-diario"><span class="slider"></span></label></div>
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem;"><span>&rdsh; Registrar Nova Ocorrência</span><label class="switch"><input type="checkbox" id="perm-sub-nova-ocorrencia"><span class="slider"></span></label></div>
                    
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem; border-bottom: none;"><span>&rdsh; Histórico de Relatórios</span><label class="switch"><input type="checkbox" id="perm-reports-hist"><span class="slider"></span></label></div>
                    <div class="permission-item" style="padding-left: 20px; font-size: 0.85rem;"><span>&rdsh; Histórico de Ocorrências</span><label class="switch"><input type="checkbox" id="perm-occ-hist"><span class="slider"></span></label></div>

                    <div class="permission-item"><span>Box Gestão de Obras</span><label class="switch"><input type="checkbox" id="perm-management"><span class="slider"></span></label></div>
                    <div class="permission-item"><span>Box Consulta de Projeto</span><label class="switch"><input type="checkbox" id="perm-query"><span class="slider"></span></label></div>
                    <div class="permission-item"><span>Box Comunicação</span><label class="switch"><input type="checkbox" id="perm-communication"><span class="slider"></span></label></div>
                    <div class="permission-item"><span>Box Funcionários</span><label class="switch"><input type="checkbox" id="perm-employees"><span class="slider"></span></label></div>
                    <div class="permission-item"><span>Box Almoxarifado</span><label class="switch"><input type="checkbox" id="perm-warehouse"><span class="slider"></span></label></div>
                    <div class="permission-item"><span>Box Configurações (D.S.P)</span><label class="switch"><input type="checkbox" id="perm-settings"><span class="slider"></span></label></div>
                    <div class="permission-item" style="border-bottom:none;"><span>Editar Relatórios (Permissão Mestre Excluir/Editar)</span><label class="switch"><input type="checkbox" id="perm-edit-reports"><span class="slider"></span></label></div>
                    
                    <button onclick="savePermissions()" style="margin-top:20px;">Salvar Permissões</button>
                </div>
            </div>
        </div>

        <div id="audit-panel" style="display: none;">
            <div class="card-panel">
                <h3>Auditoria de Logs</h3>
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <div class="search-container" style="flex: 1; margin-bottom: 0;">
                        <span class="material-icons-round icon">search</span>
                        <input type="text" id="audit-search" onkeyup="filterAuditLogs()" placeholder="Filtrar registros..." style="margin-bottom: 0;">
                    </div>
                    <button class="btn-icon btn-view" onclick="printAuditLogs()" title="Imprimir Relatório" style="width: 45px; height: 45px;"><span class="material-icons-round">print</span></button>
                    <button class="btn-icon btn-delete" onclick="clearAuditLogs()" title="Limpar Histórico" style="width: 45px; height: 45px;"><span class="material-icons-round">delete_forever</span></button>
                </div>
                <div class="table-responsive scrollable-box"><table class="user-table"><thead><tr><th>Data</th><th>Usuário</th><th>Ação</th><th>Detalhes</th></tr></thead><tbody id="audit-list-body"></tbody></table></div>
            </div>
        </div>

        <div id="user-dashboard">
            <div id="weather-widget" class="modern-weather-widget" style="margin-bottom: 20px; display: none;">
                <div class="weather-header">
                    <div>
                        <h3 style="margin-bottom: 5px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons-round">location_on</span> <span id="weather-location">Localizando...</span>
                        </h3>
                        <div class="weather-datetime">
                            <span id="live-date">Carregando data...</span> • <span id="live-time" style="font-weight: bold;">--:--</span>
                        </div>
                    </div>
                    <span id="current-weather-icon" class="material-icons-round" style="font-size: 40px; opacity: 0.9;">wb_sunny</span>
                </div>
                
                <div class="weather-current">
                    <div id="current-temp" class="weather-temp-main">--°</div>
                    <div style="line-height: 1.2;">
                        <div id="current-desc" style="font-weight: 600; font-size: 1.1rem;">--</div>
                        <div id="current-minmax" style="font-size: 0.85rem; opacity: 0.8;">Max --° / Min --°</div>
                    </div>
                </div>

                <div id="weather-days" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 5px; margin-top: 15px;">
                    <div style="width: 100%; text-align: center; opacity: 0.8;">Buscando dados meteorológicos...</div>
                </div>
            </div>

            <div id="chart-widget" style="margin-bottom: 20px; display: none;">
                <div class="hud-dashboard">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div class="hud-box-title" style="font-size: 1.1rem; text-align: left; margin: 0; border-bottom: none; color: #FFF; text-transform: uppercase;">Desempenho e Métricas 3D</div>
                        <select id="hud-chart-filter" onchange="loadDashboardChart()" style="background: rgba(255, 255, 255, 0.2); color: #FFF; border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 8px; padding: 6px 12px; outline: none; margin-bottom: 0; font-family: inherit; font-weight: bold;">
                            <option value="all" style="color: #000;">Todas as Obras</option>
                        </select>
                    </div>
                    
                    <div class="hud-mid-row">
                        <div class="hud-chart-box">
                            <div class="hud-box-title">PRODUÇÃO E RISCOS ///</div>
                            <div style="position: relative; height: 280px; width: 100%;">
                                <div id="hud-bar-container" style="height: 100%; width: 100%;"></div>
                            </div>
                        </div>
                        
                        <div class="hud-chart-box">
                            <div class="hud-box-title">PROGRESSO DE RELATÓRIOS (PIZZA 3D) ///</div>
                            <div style="position: relative; height: 280px; width: 100%;">
                                <div id="hud-pie-container" style="height: 100%; width: 100%;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="hud-bot-row">
                        <div class="hud-box-title">TEMPO RESTANTE (DIAS) ///</div>
                        <div class="hud-h-bar-container" id="hud-bot-bars">
                        </div>
                    </div>
                </div>
            </div>

            <div id="works-gallery-widget" class="card-panel" style="margin-bottom: 20px; display: none;">
                <h3 style="color: var(--primary); margin-bottom: 15px;">Galeria de Obras</h3>
                <div id="works-gallery-scroll" style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px;">
                    </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card"><div><p style="color:var(--secondary)">Obras Ativas</p><h2>12</h2></div><div class="icon-box"><span class="material-icons-round">engineering</span></div></div>
                <div class="stat-card"><div><p style="color:var(--secondary)">Relatórios</p><h2>8</h2></div><div class="icon-box" style="background:#CCFBF1; color:var(--accent);"><span class="material-icons-round">description</span></div></div>
            </div>
            <div style="margin-top:40px; text-align:center; padding:40px 20px; background:white; border-radius:16px;">
                <span class="material-icons-round" style="font-size:48px; color:#CBD5E1;">touch_app</span>
                <p>Selecione uma opção no menu.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, query, where, writeBatch, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBgHHH9FznfecaHgMERimVCA1cy3q2MLg4",
            authDomain: "obraspro-e47c2.firebaseapp.com",
            projectId: "obraspro-e47c2",
            storageBucket: "obraspro-e47c2.firebasestorage.app",
            messagingSenderId: "1065186394341",
            appId: "1:1065186394341:web:26b91c586047cf758c540c",
            measurementId: "G-79ZL5T8FYW"
        };

        let app, db;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); } catch (e) { console.error(e); }

        let currentUser = null;
        let editingUserId = null;
        let editingEmployeeId = null;
        let editingContractId = null; 
        let editingContratanteId = null; 
        let editingTermoId = null;
        let editingManagementId = null; 
        let allAuditLogs = [];
        let allProjectsForQuery = [];
        let dashboardChartInstance = null; 
        
        const roleConfig = { 
            'admin': { label: 'Admin', color: '#DBEAFE', text: '#1E40AF' }, 
            'user': { label: 'Usuário', color: '#F1F5F9', text: '#64748B' }, 
            'engenheiro': { label: 'Eng. Civil', color: '#DCFCE7', text: '#15803D' }, 
            'gestor': { label: 'Gestor', color: '#F3E8FF', text: '#7E22CE' }, 
            'almoxarifado': { label: 'Almoxarife', color: '#FEF3C7', text: '#D97706' }, 
            'funcionario': { label: 'Func.', color: '#E0F2FE', text: '#0369A1' },
            'fiscal': { label: 'Fiscal', color: '#FFEDD5', text: '#C2410C' },
            'empreiteiro': { label: 'Empreiteiro', color: '#FFE4E6', text: '#BE123C' },
            'eng_mecanico': { label: 'Eng. Mecânico', color: '#D1FAE5', text: '#047857' },
            'eng_eletrico': { label: 'Eng. Elétrico', color: '#FEF9C3', text: '#B45309' },
            'eng_ambiental': { label: 'Eng. Ambiental', color: '#ECFCCB', text: '#4D7C0F' },
            'eng_estruturas': { label: 'Eng. Estruturas', color: '#E0E7FF', text: '#3730A3' },
            'eng_geotecnico': { label: 'Eng. Geotécnico', color: '#FCE7F3', text: '#BE185D' },
            'eng_seguranca': { label: 'Eng. Segurança', color: '#FFDDEE', text: '#BE123C' },
            'eng_producao': { label: 'Eng. Produção', color: '#F3F4F6', text: '#1F2937' },
            'arquiteto': { label: 'Arquiteto', color: '#E0F2FE', text: '#0369A1' },
            'tec_edificacoes': { label: 'Téc. Edificações', color: '#F1F5F9', text: '#475569' }
        };

        window.formatCurrency = (input) => {
            let v = input.value.replace(/\D/g,'');
            v = (v/100).toFixed(2) + '';
            v = v.replace(".", ",");
            v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            input.value = v;
        }

        async function logAction(action, details) {
            if(!currentUser) return;
            await addDoc(collection(db, "audit_logs"), { timestamp: new Date().toISOString(), userEmail: currentUser.email, action, details });
        }

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('mobile-backdrop');
            if (window.innerWidth <= 992) { sidebar.classList.toggle('mobile-open'); backdrop.classList.toggle('active'); } 
            else { sidebar.classList.toggle('collapsed'); }
        };

        function checkMobileClose() {
            if (window.innerWidth <= 992) { document.getElementById('sidebar').classList.remove('mobile-open'); document.getElementById('mobile-backdrop').classList.remove('active'); }
        }

        function hideAllPanels() {
            const panels = ['user-dashboard', 'admin-panel', 'settings-panel', 'audit-panel', 'termo-abertura-panel', 'tap-panel', 'contract-panel', 'contratante-panel', 'diaries-panel', 'occurrences-panel', 'communication-panel', 'management-panel', 'employees-panel', 'warehouse-panel', 'query-panel', 'upload-project-panel'];
            panels.forEach(id => document.getElementById(id).style.display = 'none');
        }

        window.resetToDashboard = () => {
            hideAllPanels();
            checkMobileClose();
            document.getElementById('user-dashboard').style.display = 'block';
            if(currentUser) loadDashboardChart(); 
        }

        async function loadWeather() {
            const widget = document.getElementById('weather-widget');
            const locationText = document.getElementById('weather-location');
            const daysContainer = document.getElementById('weather-days');
            
            widget.style.display = 'block'; 

            const updateClock = () => {
                const now = new Date();
                const timeEl = document.getElementById('live-time');
                const dateEl = document.getElementById('live-date');
                if(timeEl) timeEl.innerText = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                if(dateEl) {
                    let dStr = now.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                    dateEl.innerText = dStr;
                }
            };
            setInterval(updateClock, 1000);
            updateClock();

            const getIconAndDesc = (code) => {
                if (code === 0) return { icon: 'wb_sunny', desc: 'Céu Limpo' }; 
                if (code <= 3) return { icon: 'partly_cloudy_day', desc: 'Parcialmente Nublado' }; 
                if (code <= 48) return { icon: 'foggy', desc: 'Névoa/Neblina' }; 
                if (code <= 67) return { icon: 'water_drop', desc: 'Chuva Leve/Garoa' }; 
                if (code <= 77) return { icon: 'ac_unit', desc: 'Neve' }; 
                if (code <= 82) return { icon: 'rainy', desc: 'Chuva' }; 
                if (code <= 99) return { icon: 'thunderstorm', desc: 'Tempestade' }; 
                return { icon: 'cloud', desc: 'Nublado' };
            };

            const fetchWeather = async (lat, lon) => {
                try {
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                        const geoData = await geoRes.json();
                        locationText.innerText = geoData.address.city || geoData.address.town || geoData.address.village || geoData.address.municipality || "Sua Região";
                    } catch(e) {
                        locationText.innerText = "Localização Atual (GPS)";
                    }

                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto`);
                    const data = await response.json();
                    
                    if (!data.daily || !data.current_weather) throw new Error("Sem dados");

                    const current = data.current_weather;
                    const todayMax = Math.round(data.daily.temperature_2m_max[0]);
                    const todayMin = Math.round(data.daily.temperature_2m_min[0]);
                    const currentInfo = getIconAndDesc(current.weathercode);

                    document.getElementById('current-temp').innerText = `${Math.round(current.temperature)}°`;
                    document.getElementById('current-desc').innerText = currentInfo.desc;
                    document.getElementById('current-minmax').innerText = `Max ${todayMax}° / Min ${todayMin}°`;
                    document.getElementById('current-weather-icon').innerText = currentInfo.icon;

                    daysContainer.innerHTML = '';
                    for (let i = 1; i < 7; i++) {
                        const date = new Date(data.daily.time[i]);
                        const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.', '').toUpperCase();
                        const max = Math.round(data.daily.temperature_2m_max[i]);
                        const min = Math.round(data.daily.temperature_2m_min[i]);
                        const info = getIconAndDesc(data.daily.weathercode[i]);

                        const dayCard = document.createElement('div');
                        dayCard.className = 'modern-weather-day';
                        dayCard.innerHTML = `
                            <div class="day-name">${dayName}</div>
                            <div class="material-icons-round weather-icon">${info.icon}</div>
                            <div class="temp-range">${max}° <span style="opacity:0.6; font-size:0.75rem;">${min}°</span></div>
                        `;
                        daysContainer.appendChild(dayCard);
                    }
                } catch (e) {
                    console.error(e);
                    daysContainer.innerHTML = '<small style="color:white;">Erro ao carregar clima.</small>';
                }
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => fetchWeather(position.coords.latitude, position.coords.longitude),
                    () => fetchWeather(-22.8269, -43.0539) 
                );
            } else {
                fetchWeather(-22.8269, -43.0539);
            }
        }

        async function loadWorksGallery() {
            const container = document.getElementById('works-gallery-scroll');
            const widget = document.getElementById('works-gallery-widget');
            
            const snap = await getDocs(collection(db, "construction_sites"));
            let hasContent = false;
            container.innerHTML = '';

            snap.forEach(d => {
                const data = d.data();
                if(data.photo && data.photo.trim() !== "") {
                    hasContent = true;
                    const card = document.createElement('div');
                    card.className = 'work-gallery-card';
                    card.onclick = () => viewFileFullscreen(data.photo, data.name); 
                    card.innerHTML = `
                        <img src="${data.photo}" class="work-gallery-img" loading="lazy" onerror="this.src='https://via.placeholder.com/200x140?text=Sem+Foto'">
                        <div class="work-gallery-overlay">
                            <div class="work-gallery-title">${data.name}</div>
                        </div>
                    `;
                    container.appendChild(card);
                }
            });

            if(hasContent) { widget.style.display = 'block'; } else { widget.style.display = 'none'; }
        }

        window.loadDashboardChart = async () => {
            const widget = document.getElementById('chart-widget');
            const botBars = document.getElementById('hud-bot-bars');
            const filterSelect = document.getElementById('hud-chart-filter');
            
            try {
                const workforceSnap = await getDocs(collection(db, "workforce"));
                const occSnap = await getDocs(collection(db, "occurrences"));
                const sitesSnap = await getDocs(collection(db, "construction_sites")); 
                const reportsSnap = await getDocs(collection(db, "daily_reports")); 
                
                const uniqueProjects = [];
                const projectDataMap = {}; 
                
                sitesSnap.forEach(d => {
                    const s = d.data();
                    if(!uniqueProjects.includes(s.name)) {
                        uniqueProjects.push(s.name);
                        const cVal = parseFloat(s.valContract?.replace(/\D/g,''))/100 || 0;
                        const mVal = parseFloat(s.valMeasured?.replace(/\D/g,''))/100 || 0;
                        projectDataMap[s.name] = { 
                            startDate: s.startDate || null, 
                            endDate: s.endDate || null,
                            empCount: 0,
                            occCount: 0,
                            reportsCount: 0
                        }; 
                    }
                });

                if(uniqueProjects.length === 0) {
                    widget.style.display = 'none';
                    return;
                }

                widget.style.display = 'block';

                if (filterSelect.options.length <= 1) {
                    uniqueProjects.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p; opt.text = p; opt.style.color = "#000";
                        filterSelect.appendChild(opt);
                    });
                }

                const selectedProj = filterSelect.value;
                let filteredProjects = uniqueProjects;
                if (selectedProj !== 'all') {
                    filteredProjects = [selectedProj];
                }

                workforceSnap.forEach(w => { if(projectDataMap[w.data().work]) projectDataMap[w.data().work].empCount++; });
                occSnap.forEach(o => { if(projectDataMap[o.data().project]) projectDataMap[o.data().project].occCount++; });
                reportsSnap.forEach(r => { if(projectDataMap[r.data().project]) projectDataMap[r.data().project].reportsCount++; });

                const renderData = filteredProjects.map(p => {
                    const d = projectDataMap[p];
                    
                    let totalDays = 1;
                    if (d.startDate && d.endDate) {
                        const start = new Date(d.startDate + 'T00:00:00');
                        const end = new Date(d.endDate + 'T00:00:00');
                        totalDays = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));
                    } else {
                        totalDays = d.reportsCount > 0 ? d.reportsCount + 30 : 100; 
                    }

                    let progress = Math.min(Math.round((d.reportsCount / totalDays) * 100), 100);
                    
                    let daysLeft = 0;
                    if (d.endDate) {
                        const end = new Date(d.endDate + 'T00:00:00');
                        const diff = end - new Date();
                        daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
                    } else {
                        daysLeft = Math.floor(Math.random() * 100) + 20; 
                    }

                    return { name: p, progress, empCount: d.empCount, occCount: d.occCount, daysLeft, reportsCount: d.reportsCount };
                });

                botBars.innerHTML = '';
                const botElements = renderData.slice(0, 4); 
                let maxDays = Math.max(...botElements.map(b => b.daysLeft)) || 100;
                if (maxDays <= 0) maxDays = 100;

                botElements.forEach(item => {
                    let fillPct = Math.max(0, Math.min((item.daysLeft / maxDays) * 100, 100));
                    let color = item.daysLeft < 0 ? '#FCA5A5' : '#FFF'; 
                    let valTxt = item.daysLeft < 0 ? 'Atrasada' : `${item.daysLeft} Dias`;
                    
                    botBars.innerHTML += `
                        <div class="hud-h-bar-row">
                            <div class="hud-h-bar-label">${item.name}</div>
                            <div class="hud-h-bar-track">
                                <div class="hud-h-bar-fill" style="width: ${fillPct}%; background:${color}; box-shadow: 0 0 8px ${color}">
                                    <div class="hud-h-bar-dot" style="box-shadow: 0 0 8px ${color}"></div>
                                </div>
                            </div>
                            <div class="hud-h-bar-val" style="color:${color}">${valTxt}</div>
                        </div>
                    `;
                });

                const labels = renderData.map(d => d.name);
                const empData = renderData.map(d => d.empCount);
                const occData = renderData.map(d => d.occCount);
                const pieData = renderData.map(d => ({ name: d.name, y: d.progress > 0 ? d.progress : 1 }));

                Highcharts.setOptions({
                    colors: ['#3B82F6', '#EF4444', '#F59E0B', '#10B981', '#EAB308'] 
                });

                Highcharts.chart('hud-bar-container', {
                    chart: {
                        type: 'column',
                        backgroundColor: 'transparent',
                        options3d: { enabled: true, alpha: 15, beta: 15, depth: 50, viewDistance: 25 }
                    },
                    title: { text: null },
                    xAxis: { categories: labels, labels: { style: { color: '#FFF', fontWeight: 'bold' } } },
                    yAxis: { title: { text: null }, labels: { style: { color: '#FFF' } }, gridLineColor: 'rgba(255,255,255,0.1)' },
                    plotOptions: { column: { depth: 25 } },
                    series: [
                        { name: 'Funcionários', data: empData },
                        { name: 'Ocorrências', data: occData },
                        { type: 'spline', name: 'Tendência', data: empData.map((v, i) => v + occData[i] + 2), color: '#EF4444', lineWidth: 4, marker: { enabled: false } }
                    ],
                    legend: { itemStyle: { color: '#FFF' }, itemHoverStyle: { color: '#93C5FD' } }
                });

                Highcharts.chart('hud-pie-container', {
                    chart: {
                        type: 'pie',
                        backgroundColor: 'transparent',
                        options3d: { enabled: true, alpha: 45, beta: 0 }
                    },
                    title: { text: null },
                    tooltip: { pointFormat: '{series.name}: <b>{point.y}%</b>' },
                    plotOptions: {
                        pie: {
                            innerSize: 0,
                            depth: 35,
                            dataLabels: { enabled: true, format: '{point.name}', style: { color: '#FFF', textOutline: 'none', fontSize: '11px' } }
                        }
                    },
                    series: [{
                        name: 'Progresso Real',
                        data: pieData
                    }],
                    legend: { enabled: false }
                });

            } catch(e) {
                console.error("Erro ao carregar Gráficos 3D", e);
            }
        };

        document.getElementById('login-password').addEventListener('keypress', function (e) { if (e.key === 'Enter') handleLogin(); });

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const btn = document.getElementById('btn-login');
            const msg = document.getElementById('login-msg');

            if(!email || !pass) { msg.innerText = "Preencha e-mail e senha."; return; }

            btn.innerText = "Verificando...";
            msg.innerText = "";

            try {
                const usersRef = collection(db, "users");
                const qInit = await getDocs(query(usersRef));
                if(qInit.empty) {
                    await addDoc(usersRef, { email: 'admin@obras.com', pass: 'admin123', role: 'admin', permissions: { access_settings: true } });
                }

                const q = query(usersRef, where("email", "==", email), where("pass", "==", pass));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    const docData = snap.docs[0].data();
                    currentUser = { id: snap.docs[0].id, ...docData };
                    document.getElementById('login-overlay').style.display = 'none';
                    await logAction("Login", "Acesso ao sistema");
                    initInterface();
                } else {
                    msg.innerText = "Dados incorretos.";
                    btn.innerText = "Acessar Painel";
                }
            } catch (e) { 
                console.error("Erro login:", e);
                msg.innerText = "Erro de conexão com Firebase.";
                btn.innerText = "Acessar Painel";
            }
        };

        window.handleLogout = () => location.reload();

        function initInterface() {
            document.getElementById('user-name-display').innerText = currentUser.email.split('@')[0];
            const roleInfo = roleConfig[currentUser.role] || roleConfig['user'];
            document.getElementById('user-role-display').innerText = roleInfo.label;
            
            if (currentUser.role === 'admin') {
                ['admin-menu-box', 'menu-tap', 'menu-diaries', 'menu-communication', 'menu-management', 'menu-employees', 'menu-warehouse', 'menu-query'].forEach(id => document.getElementById(id).style.display = 'block');
                
                ['menu-sub-termo-abertura', 'menu-sub-prof', 'menu-sub-contratante', 'menu-sub-dados-obra', 'menu-sub-relatorio-diario', 'menu-sub-nova-ocorrencia', 'list-termo-card', 'list-contract-card', 'list-contratante-card', 'list-tap-card', 'list-diaries-card', 'list-occ-card', 'list-mgmt-card', 'form-termo-card', 'form-contract-card', 'form-contratante-card', 'form-tap-card', 'form-diaries-card', 'form-occ-card'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.style.display = 'block';
                });
            } else {
                const p = currentUser.permissions || {};
                
                // Módulos Principais
                document.getElementById('menu-tap').style.display = (p.access_tap !== false) ? 'block' : 'none';
                document.getElementById('menu-diaries').style.display = (p.access_diaries !== false) ? 'block' : 'none';
                document.getElementById('menu-management').style.display = (p.access_management !== false) ? 'block' : 'none';
                document.getElementById('menu-query').style.display = (p.access_query !== false) ? 'block' : 'none';
                document.getElementById('menu-communication').style.display = (p.access_communication !== false) ? 'block' : 'none';
                document.getElementById('menu-employees').style.display = (p.access_employees !== false) ? 'block' : 'none';
                document.getElementById('menu-warehouse').style.display = (p.access_warehouse !== false) ? 'block' : 'none';
                document.getElementById('admin-menu-box').style.display = (p.access_settings === true) ? 'block' : 'none';

                const safeShow = (id, hasPerm) => { const el = document.getElementById(id); if(el) el.style.display = hasPerm ? 'block' : 'none'; };
                
                // Subcategorias do Menu
                safeShow('menu-sub-termo-abertura', p.access_sub_termo !== false);
                safeShow('menu-sub-prof', p.access_sub_prof !== false);
                safeShow('menu-sub-contratante', p.access_sub_contratante !== false);
                safeShow('menu-sub-dados-obra', p.access_sub_dados_obra !== false);
                safeShow('menu-sub-relatorio-diario', p.access_sub_relatorio_diario !== false);
                safeShow('menu-sub-nova-ocorrencia', p.access_sub_nova_ocorrencia !== false);

                // Tabelas de Visualização Específicas
                safeShow('list-termo-card', p.access_list_termo !== false);
                safeShow('list-contract-card', p.access_list_prof !== false);
                safeShow('list-contratante-card', p.access_list_contratante !== false);
                safeShow('list-tap-card', p.access_list_tap !== false);
                
                safeShow('list-diaries-card', p.access_list_diario !== false);
                safeShow('list-occ-card', p.access_list_occ !== false);
                
                safeShow('list-mgmt-card', p.access_management !== false);

                // Formulários
                const canEditForms = p.can_edit_reports === true;
                safeShow('form-termo-card', p.access_sub_termo !== false);
                safeShow('form-contract-card', p.access_sub_prof !== false);
                safeShow('form-contratante-card', p.access_sub_contratante !== false);
                safeShow('form-tap-card', p.access_sub_dados_obra !== false);
                safeShow('form-diaries-card', p.access_sub_relatorio_diario !== false);
                safeShow('form-occ-card', p.access_sub_nova_ocorrencia !== false);
            }
            document.getElementById('user-dashboard').style.display = 'block';
            
            loadWeather();
            loadWorksGallery();
            loadDashboardChart(); 
        }

        window.goToPermissions = async (userId) => {
            if(currentUser.role !== 'admin') return;
            await showSettingsPanel();
            const select = document.getElementById('select-user-permission');
            await populateUserSelect();
            setTimeout(async () => {
                select.value = userId;
                await loadUserPermissions();
                document.getElementById('permissions-container').scrollIntoView({behavior: 'smooth'});
            }, 500);
        };

        // --- UPLOAD DE PROJETO ---
        window.showUploadProjectPanel = async () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('upload-project-panel').style.display = 'block';
            
            const sel = document.getElementById('upload-project-select');
            sel.innerHTML = '<option value="">Carregando obras...</option>';
            
            const snap = await getDocs(collection(db, "construction_sites"));
            sel.innerHTML = '<option value="">Selecione a Obra...</option>';
            
            snap.forEach(d => { 
                const o = document.createElement('option');
                o.value = d.id; 
                o.text = d.data().name; 
                sel.appendChild(o); 
            });
        };

        window.handleUploadProjectFile = async () => {
            const sel = document.getElementById('upload-project-select');
            const projectId = sel.value; 
            const projectName = sel.options[sel.selectedIndex].text;
            const fileInput = document.getElementById('project-file-input');
            const file = fileInput.files[0];
            const desc = document.getElementById('project-file-desc').value;

            if(!projectId || !file) return alert("Selecione a obra e um arquivo!");
            if(file.size > 800000) return alert("Arquivo muito grande para esta demo (Max 800kb).");

            const btn = document.getElementById('btn-upload-file');
            const originalText = btn.innerText;
            btn.innerText = "Enviando...";
            btn.disabled = true;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const fileUrl = e.target.result;
                try {
                    await addDoc(collection(db, "project_files"), {
                        projectId: projectId, projectName: projectName, url: fileUrl, description: desc || file.name, uploadedAt: new Date().toISOString(), uploadedBy: currentUser.email, fileType: file.type
                    });
                    await logAction("Upload", `Arquivo: ${desc || file.name} | Obra ID: ${projectId}`);
                    alert("Arquivo enviado com sucesso!");
                    document.getElementById('project-file-desc').value = '';
                    fileInput.value = '';
                } catch(err) { console.error(err); alert("Erro ao salvar."); } finally { btn.innerText = originalText; btn.disabled = false; }
            };
            reader.onerror = function() { alert("Erro ao ler arquivo."); btn.innerText = originalText; btn.disabled = false; };
            reader.readAsDataURL(file);
        };

        // --- CONSULTA DE PROJETO ---
        window.showQueryPanel = async () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('query-panel').style.display = 'block';
            renderProjectQueryList();
        };

        async function renderProjectQueryList() {
            const tbody = document.getElementById('query-list-body');
            tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
            
            const snap1 = await getDocs(collection(db, "projects"));
            const snap2 = await getDocs(collection(db, "construction_sites"));
            
            allProjectsForQuery = [];
            snap1.forEach(d => allProjectsForQuery.push({id: d.id, ...d.data(), origin: 'tap'}));
            snap2.forEach(d => allProjectsForQuery.push({id: d.id, ...d.data(), origin: 'site'}));
            
            filterProjectQuery();
        }

        window.filterProjectQuery = () => {
            const term = document.getElementById('project-query-search').value.toLowerCase();
            const tbody = document.getElementById('query-list-body');
            tbody.innerHTML = "";
            
            const filtered = allProjectsForQuery.filter(p => p.name.toLowerCase().includes(term) || (p.clientName && p.clientName.toLowerCase().includes(term)));
            
            const canEdit = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.can_edit_reports);

            filtered.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${p.name}</b></td>
                    <td><small>${p.type || 'Obra Civil'}</small></td>
                    <td>${p.clientName || '-'}</td>
                    <td><span class="badge badge-active">${p.status || 'Ativo'}</span></td>
                    <td>
                        <div class="action-group">
                            <button class="btn-icon btn-view" onclick="alert('Detalhes: ${p.description || 'Sem descrição'}')" title="Ver Detalhes"><span class="material-icons-round">visibility</span></button>
                            <button class="btn-icon" style="background:#E0F2FE; color:#0284C7;" onclick="openProjectFiles('${p.id}')" title="Ver Arquivos"><span class="material-icons-round">folder_open</span></button>
                            ${canEdit ? `<button class="btn-icon btn-delete" onclick="deleteProjectFromQuery('${p.id}', '${p.origin}')" title="Excluir Projeto"><span class="material-icons-round">delete</span></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.deleteProjectFromQuery = async (id, origin) => {
            const r = prompt("Para confirmar a exclusão, digite o motivo:"); if (!r) return;
            if (!confirm("Tem certeza? Isso apagará permanentemente o registro.")) return;
            try {
                const collectionName = (origin === 'tap') ? 'projects' : 'construction_sites';
                await deleteDoc(doc(db, collectionName, id));
                await logAction("Exclusão (Consulta)", `ID: ${id} | Origem: ${collectionName} | Motivo: ${r}`);
                alert("Projeto excluído com sucesso."); renderProjectQueryList(); 
            } catch (e) { console.error(e); alert("Erro ao excluir."); }
        };

        window.openProjectFiles = async (projectId) => {
            const modal = document.getElementById('files-modal');
            const container = document.getElementById('files-list-container');
            container.innerHTML = '<p style="text-align:center; margin-top:20px;">Carregando arquivos...</p>';
            modal.style.display = 'flex'; 

            const q = query(collection(db, "project_files"), where("projectId", "==", projectId));
            const snap = await getDocs(q);

            container.innerHTML = '';
            if(snap.empty) { container.innerHTML = '<p style="text-align:center; color:var(--secondary); margin-top:20px;">Nenhum arquivo vinculado a esta obra.</p>'; return; }

            const canEdit = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.can_edit_reports);

            snap.forEach(d => {
                const file = d.data();
                const item = document.createElement('div');
                item.className = 'file-item-card';
                item.innerHTML = `
                    <div class="file-info">
                        <span class="file-name">${file.description}</span>
                        <span class="file-desc">Enviado em: ${new Date(file.uploadedAt).toLocaleDateString()}</span>
                    </div>
                    <div class="action-group">
                        <button class="btn-icon btn-view" onclick="viewFileFullscreen('${file.url}', '${file.description}')" title="Visualizar 100%"><span class="material-icons-round">fullscreen</span></button>
                        ${canEdit ? `<button class="btn-icon btn-delete" onclick="deleteProjectFile('${d.id}', '${projectId}')" title="Excluir"><span class="material-icons-round">delete</span></button>` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
        };

        window.viewFileFullscreen = (url, desc) => {
            const overlay = document.getElementById('fullscreen-overlay');
            const content = document.getElementById('fullscreen-content');
            const caption = document.getElementById('fullscreen-caption');
            content.src = url; caption.innerText = desc || "Sem descrição"; overlay.style.display = 'flex';
        };

        window.deleteProjectFile = async (fileId, projectId) => {
            if(!confirm("Tem certeza que deseja excluir este arquivo?")) return;
            await deleteDoc(doc(db, "project_files", fileId));
            await logAction("Exclusão Arquivo", `ID Arquivo: ${fileId}`);
            openProjectFiles(projectId);
        };

        // --- TERMO DE ABERTURA (TAP) ---
        window.showTermoAberturaPanel = () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('termo-abertura-panel').style.display = 'block';
            renderTermosAbertura();
        };

        window.handleSaveTermoAbertura = async () => {
            const data = {
                nomeProjeto: document.getElementById('t-nome-projeto').value,
                gerente: document.getElementById('t-gerente').value,
                sponsor: document.getElementById('t-sponsor').value,
                justificativa: document.getElementById('t-justificativa').value,
                objetivos: document.getElementById('t-objetivos').value,
                premissas: document.getElementById('t-premissas').value,
                stakeholders: document.getElementById('t-stakeholders').value,
                orcamento: document.getElementById('t-orcamento').value,
                prazo: document.getElementById('t-prazo').value,
                createdBy: currentUser.email,
                timestamp: new Date().toISOString()
            };

            if(!data.nomeProjeto) return alert("Nome do Projeto é obrigatório!");

            if(editingTermoId) {
                await updateDoc(doc(db, "project_charters", editingTermoId), data);
                await logAction("TAP", `Atualizou TAP: ${data.nomeProjeto}`);
                alert("Atualizado com sucesso!");
                cancelEditTermoAbertura();
            } else {
                await addDoc(collection(db, "project_charters"), data);
                await logAction("TAP", `Criou TAP: ${data.nomeProjeto}`);
                alert("Salvo com sucesso!");
                document.querySelectorAll('#termo-abertura-panel input, #termo-abertura-panel textarea').forEach(el => el.value = '');
            }
            renderTermosAbertura();
        };

        window.editTermoAbertura = async (id) => {
            const snap = await getDoc(doc(db, "project_charters", id));
            if(!snap.exists()) return;
            const data = snap.data();
            editingTermoId = id;

            document.getElementById('t-nome-projeto').value = data.nomeProjeto || '';
            document.getElementById('t-gerente').value = data.gerente || '';
            document.getElementById('t-sponsor').value = data.sponsor || '';
            document.getElementById('t-justificativa').value = data.justificativa || '';
            document.getElementById('t-objetivos').value = data.objetivos || '';
            document.getElementById('t-premissas').value = data.premissas || '';
            document.getElementById('t-stakeholders').value = data.stakeholders || '';
            document.getElementById('t-orcamento').value = data.orcamento || '';
            document.getElementById('t-prazo').value = data.prazo || '';

            document.getElementById('btn-save-termo').innerText = "Atualizar";
            document.getElementById('btn-cancel-termo').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelEditTermoAbertura = () => {
            editingTermoId = null;
            document.getElementById('btn-save-termo').innerText = "Salvar";
            document.getElementById('btn-cancel-termo').style.display = "none";
            document.querySelectorAll('#termo-abertura-panel input, #termo-abertura-panel textarea').forEach(el => el.value = '');
        };

        window.deleteTermoAbertura = async (id) => {
            if(!confirm("Tem certeza que deseja excluir este TAP?")) return;
            const r = prompt("Motivo da exclusão?"); if(!r) return;
            await deleteDoc(doc(db, "project_charters", id));
            await logAction("TAP", `Excluiu TAP ID: ${id} | Motivo: ${r}`);
            renderTermosAbertura();
        };

        window.printTermoAbertura = async (id) => {
            const snap = await getDoc(doc(db, "project_charters", id));
            if(!snap.exists()) return alert("TAP não encontrado");
            const c = snap.data();
            
            const printWindow = window.open('', '', 'height=800,width=800');
            printWindow.document.write('<html><head><title>Imprimir Termo de Abertura do Projeto</title><style>body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; color: #333; } h2 { text-align: center; border-bottom: 2px solid #2563EB; padding-bottom: 15px; color: #1E293B; text-transform: uppercase; } .field-row { margin-bottom: 15px; font-size: 14px; } .label { font-weight: bold; display: block; margin-bottom: 5px; color: #64748B; text-transform: uppercase; font-size: 12px; } .value { font-weight: 600; color: #000; padding: 10px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 8px; min-height: 20px; white-space: pre-wrap; } .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }</style></head>');
            printWindow.document.write('<body onload="setTimeout(function() { window.print(); window.close(); }, 500);"><h2>Termo de Abertura do Projeto (TAP)</h2><br><div class="field-row"><span class="label">NOME DO PROJETO</span> <div class="value">' + (c.nomeProjeto || '-') + '</div></div><div class="grid-2"><div class="field-row"><span class="label">GERENTE DO PROJETO</span> <div class="value">' + (c.gerente || '-') + '</div></div><div class="field-row"><span class="label">PATROCINADOR (SPONSOR)</span> <div class="value">' + (c.sponsor || '-') + '</div></div></div><div class="field-row"><span class="label">JUSTIFICATIVA DO PROJETO</span> <div class="value">' + (c.justificativa || '-') + '</div></div><div class="field-row"><span class="label">OBJETIVOS DO PROJETO</span> <div class="value">' + (c.objetivos || '-') + '</div></div><div class="field-row"><span class="label">PREMISSAS E RESTRIÇÕES</span> <div class="value">' + (c.premissas || '-') + '</div></div><div class="field-row"><span class="label">PRINCIPAIS STAKEHOLDERS</span> <div class="value">' + (c.stakeholders || '-') + '</div></div><div class="grid-2"><div class="field-row"><span class="label">ESTIMATIVA DE ORÇAMENTO</span> <div class="value">R$ ' + (c.orcamento || '-') + '</div></div><div class="field-row"><span class="label">ESTIMATIVA DE PRAZO</span> <div class="value">' + (c.prazo || '-') + ' Meses</div></div></div><br><br><br><div style="display: flex; justify-content: space-around; margin-top: 50px;"><div style="text-align: center;"><hr style="width: 250px; border: 1px solid #000;"><span style="font-size: 12px;">Gerente do Projeto</span></div><div style="text-align: center;"><hr style="width: 250px; border: 1px solid #000;"><span style="font-size: 12px;">Patrocinador (Sponsor)</span></div></div></body></html>');
            printWindow.document.close();
        };

        async function renderTermosAbertura() {
            const tbody = document.getElementById('termo-list-body');
            tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
            const snap = await getDocs(collection(db, "project_charters"));
            tbody.innerHTML = "";
            
            const canEdit = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.can_edit_reports);

            snap.forEach(d => {
                const c = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${c.nomeProjeto}</b></td>
                    <td>${c.gerente || '-'}</td>
                    <td>${c.prazo || '-'}</td>
                    <td>R$ ${c.orcamento || '-'}</td>
                    <td>
                        <div class="action-group">
                            ${canEdit ? `<button class="btn-icon btn-edit" onclick="editTermoAbertura('${d.id}')" title="Editar"><span class="material-icons-round">edit</span></button>` : ''}
                            <button class="btn-icon btn-print" onclick="printTermoAbertura('${d.id}')" title="Imprimir"><span class="material-icons-round">print</span></button>
                            ${canEdit ? `<button class="btn-icon btn-delete" onclick="deleteTermoAbertura('${d.id}')" title="Excluir"><span class="material-icons-round">delete</span></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- CONTRATO PROFISSIONAL ---
        window.showContractPanel = () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('contract-panel').style.display = 'block';
            renderContracts();
        };

        window.handleSaveContract = async () => {
            const data = {
                nome: document.getElementById('cp-nome').value,
                titulo: document.getElementById('cp-titulo').value,
                crea: document.getElementById('cp-crea').value,
                rg: document.getElementById('cp-rg').value,
                cpf: document.getElementById('cp-cpf').value,
                endereco: document.getElementById('cp-endereco').value,
                bairro: document.getElementById('cp-bairro').value,
                cidade: document.getElementById('cp-cidade').value,
                uf: document.getElementById('cp-uf').value,
                cep: document.getElementById('cp-cep').value,
                fone: document.getElementById('cp-fone').value,
                celular: document.getElementById('cp-celular').value,
                email: document.getElementById('cp-email').value,
                createdBy: currentUser.email
            };

            if(!data.nome) return alert("Nome do Profissional é obrigatório");

            if(editingContractId) {
                await updateDoc(doc(db, "professional_contracts", editingContractId), data);
                await logAction("Profissionais", `Atualizou profissional: ${data.nome}`);
                alert("Atualizado com sucesso!");
                cancelEditContract();
            } else {
                await addDoc(collection(db, "professional_contracts"), data);
                await logAction("Profissionais", `Criou contrato para: ${data.nome}`);
                alert("Salvo com sucesso!");
                document.querySelectorAll('#contract-panel input').forEach(input => input.value = '');
            }
            renderContracts();
        };

        window.editContract = async (id) => {
            const snap = await getDoc(doc(db, "professional_contracts", id));
            if(!snap.exists()) return;
            const data = snap.data();
            editingContractId = id;

            document.getElementById('cp-nome').value = data.nome || '';
            document.getElementById('cp-titulo').value = data.titulo || '';
            document.getElementById('cp-crea').value = data.crea || '';
            document.getElementById('cp-rg').value = data.rg || '';
            document.getElementById('cp-cpf').value = data.cpf || '';
            document.getElementById('cp-endereco').value = data.endereco || '';
            document.getElementById('cp-bairro').value = data.bairro || '';
            document.getElementById('cp-cidade').value = data.cidade || '';
            document.getElementById('cp-uf').value = data.uf || '';
            document.getElementById('cp-cep').value = data.cep || '';
            document.getElementById('cp-fone').value = data.fone || '';
            document.getElementById('cp-celular').value = data.celular || '';
            document.getElementById('cp-email').value = data.email || '';

            document.getElementById('btn-save-cp').innerText = "Atualizar";
            document.getElementById('btn-cancel-cp').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelEditContract = () => {
            editingContractId = null;
            document.getElementById('btn-save-cp').innerText = "Salvar";
            document.getElementById('btn-cancel-cp').style.display = "none";
            document.querySelectorAll('#contract-panel input').forEach(input => input.value = '');
        };

        window.deleteContract = async (id) => {
            if(!confirm("Tem certeza que deseja excluir este contrato?")) return;
            const r = prompt("Motivo da exclusão?"); if(!r) return;
            await deleteDoc(doc(db, "professional_contracts", id));
            await logAction("Profissionais", `Excluiu Profissional ID: ${id} | Motivo: ${r}`);
            renderContracts();
        };

        window.printContract = async (id) => {
            const snap = await getDoc(doc(db, "professional_contracts", id));
            if(!snap.exists()) return alert("Contrato não encontrado");
            const c = snap.data();
            
            const printWindow = window.open('', '', 'height=800,width=800');
            printWindow.document.write('<html><head><title>Imprimir Contrato Profissional</title><style>body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; color: #333; } h2 { text-align: center; border-bottom: 2px solid #2563EB; padding-bottom: 15px; color: #1E293B; text-transform: uppercase; } .field-row { margin-bottom: 12px; font-size: 14px; } .label { font-weight: bold; display: inline-block; width: 220px; color: #64748B; } .value { font-weight: 600; color: #000; }</style></head>');
            printWindow.document.write('<body onload="setTimeout(function() { window.print(); window.close(); }, 500);"><h2>Cadastro do Profissional</h2><br><div class="field-row"><span class="label">NOME DO PROFISSIONAL:</span> <span class="value">' + (c.nome || '-') + '</span></div><div class="field-row"><span class="label">TÍTULO:</span> <span class="value">' + (c.titulo || '-') + '</span></div><div class="field-row"><span class="label">Nº DO CREA-UF \\ VISTO:</span> <span class="value">' + (c.crea || '-') + '</span></div><div class="field-row"><span class="label">Nº DO RG:</span> <span class="value">' + (c.rg || '-') + '</span></div><div class="field-row"><span class="label">Nº DO CPF:</span> <span class="value">' + (c.cpf || '-') + '</span></div><div class="field-row"><span class="label">ENDEREÇO:</span> <span class="value">' + (c.endereco || '-') + '</span></div><div class="field-row"><span class="label">BAIRRO:</span> <span class="value">' + (c.bairro || '-') + '</span></div><div class="field-row"><span class="label">CIDADE / UF:</span> <span class="value">' + (c.cidade || '-') + ' / ' + (c.uf || '-') + '</span></div><div class="field-row"><span class="label">CEP:</span> <span class="value">' + (c.cep || '-') + '</span></div><div class="field-row"><span class="label">FONE:</span> <span class="value">' + (c.fone || '-') + '</span></div><div class="field-row"><span class="label">CELULAR:</span> <span class="value">' + (c.celular || '-') + '</span></div><div class="field-row"><span class="label">E-MAIL:</span> <span class="value">' + (c.email || '-') + '</span></div><br><br><br><div style="text-align: center; margin-top: 50px;"><hr style="width: 300px; border: 1px solid #000;"><span style="font-size: 12px;">Assinatura do Profissional</span></div></body></html>');
            printWindow.document.close();
        };

        async function renderContracts() {
            const tbody = document.getElementById('contract-list-body');
            tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
            const snap = await getDocs(collection(db, "professional_contracts"));
            tbody.innerHTML = "";
            
            const canEdit = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.can_edit_reports);

            snap.forEach(d => {
                const c = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${c.nome}</b></td>
                    <td>${c.titulo || '-'}</td>
                    <td>${c.crea || '-'}</td>
                    <td>${c.celular || '-'}</td>
                    <td>
                        <div class="action-group">
                            ${canEdit ? `<button class="btn-icon btn-edit" onclick="editContract('${d.id}')" title="Editar"><span class="material-icons-round">edit</span></button>` : ''}
                            <button class="btn-icon btn-print" onclick="printContract('${d.id}')" title="Imprimir"><span class="material-icons-round">print</span></button>
                            ${canEdit ? `<button class="btn-icon btn-delete" onclick="deleteContract('${d.id}')" title="Excluir"><span class="material-icons-round">delete</span></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- CADASTRO DE CONTRATANTE ---
        window.showContratantePanel = () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('contratante-panel').style.display = 'block';
            renderContratantes();
        };

        window.handleSaveContratante = async () => {
            const data = {
                nome: document.getElementById('ct-nome').value,
                rg: document.getElementById('ct-rg').value,
                cpf: document.getElementById('ct-cpf').value,
                endereco: document.getElementById('ct-endereco').value,
                bairro: document.getElementById('ct-bairro').value,
                cidade: document.getElementById('ct-cidade').value,
                uf: document.getElementById('ct-uf').value,
                cep: document.getElementById('ct-cep').value,
                fone: document.getElementById('ct-fone').value,
                celular: document.getElementById('ct-celular').value,
                email: document.getElementById('ct-email').value,
                createdBy: currentUser.email
            };

            if(!data.nome) return alert("Nome do Contratante é obrigatório");

            if(editingContratanteId) {
                await updateDoc(doc(db, "clients_contracts", editingContratanteId), data);
                await logAction("Contratantes", `Atualizou contratante: ${data.nome}`);
                alert("Atualizado com sucesso!");
                cancelEditContratante();
            } else {
                await addDoc(collection(db, "clients_contracts"), data);
                await logAction("Contratantes", `Criou contratante: ${data.nome}`);
                alert("Salvo com sucesso!");
                document.querySelectorAll('#contratante-panel input').forEach(input => input.value = '');
            }
            renderContratantes();
        };

        window.editContratante = async (id) => {
            const snap = await getDoc(doc(db, "clients_contracts", id));
            if(!snap.exists()) return;
            const data = snap.data();
            editingContratanteId = id;

            document.getElementById('ct-nome').value = data.nome || '';
            document.getElementById('ct-rg').value = data.rg || '';
            document.getElementById('ct-cpf').value = data.cpf || '';
            document.getElementById('ct-endereco').value = data.endereco || '';
            document.getElementById('ct-bairro').value = data.bairro || '';
            document.getElementById('ct-cidade').value = data.cidade || '';
            document.getElementById('ct-uf').value = data.uf || '';
            document.getElementById('ct-cep').value = data.cep || '';
            document.getElementById('ct-fone').value = data.fone || '';
            document.getElementById('ct-celular').value = data.celular || '';
            document.getElementById('ct-email').value = data.email || '';

            document.getElementById('btn-save-ct').innerText = "Atualizar";
            document.getElementById('btn-cancel-ct').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelEditContratante = () => {
            editingContratanteId = null;
            document.getElementById('btn-save-ct').innerText = "Salvar";
            document.getElementById('btn-cancel-ct').style.display = "none";
            document.querySelectorAll('#contratante-panel input').forEach(input => input.value = '');
        };

        window.deleteContratante = async (id) => {
            if(!confirm("Tem certeza que deseja excluir este contratante?")) return;
            const r = prompt("Motivo da exclusão?"); if(!r) return;
            await deleteDoc(doc(db, "clients_contracts", id));
            await logAction("Contratantes", `Excluiu Contratante ID: ${id} | Motivo: ${r}`);
            renderContratantes();
        };

        window.printContratante = async (id) => {
            const snap = await getDoc(doc(db, "clients_contracts", id));
            if(!snap.exists()) return alert("Contratante não encontrado");
            const c = snap.data();
            
            const printWindow = window.open('', '', 'height=800,width=800');
            printWindow.document.write('<html><head><title>Imprimir Cadastro de Contratante</title><style>body { font-family: Arial, sans-serif; padding: 40px; line-height: 1.6; color: #333; } h2 { text-align: center; border-bottom: 2px solid #2563EB; padding-bottom: 15px; color: #1E293B; text-transform: uppercase; } .field-row { margin-bottom: 12px; font-size: 14px; } .label { font-weight: bold; display: inline-block; width: 220px; color: #64748B; } .value { font-weight: 600; color: #000; }</style></head>');
            printWindow.document.write('<body onload="setTimeout(function() { window.print(); window.close(); }, 500);"><h2>Cadastro de Contratante</h2><br><div class="field-row"><span class="label">NOME DO CONTRATANTE:</span> <span class="value">' + (c.nome || '-') + '</span></div><div class="field-row"><span class="label">Nº DO RG/IE:</span> <span class="value">' + (c.rg || '-') + '</span></div><div class="field-row"><span class="label">Nº DO CPF/CNPJ:</span> <span class="value">' + (c.cpf || '-') + '</span></div><div class="field-row"><span class="label">ENDEREÇO:</span> <span class="value">' + (c.endereco || '-') + '</span></div><div class="field-row"><span class="label">BAIRRO:</span> <span class="value">' + (c.bairro || '-') + '</span></div><div class="field-row"><span class="label">CIDADE / UF:</span> <span class="value">' + (c.cidade || '-') + ' / ' + (c.uf || '-') + '</span></div><div class="field-row"><span class="label">CEP:</span> <span class="value">' + (c.cep || '-') + '</span></div><div class="field-row"><span class="label">FONE:</span> <span class="value">' + (c.fone || '-') + '</span></div><div class="field-row"><span class="label">CELULAR:</span> <span class="value">' + (c.celular || '-') + '</span></div><div class="field-row"><span class="label">E-MAIL:</span> <span class="value">' + (c.email || '-') + '</span></div><br><br><br><div style="text-align: center; margin-top: 50px;"><hr style="width: 300px; border: 1px solid #000;"><span style="font-size: 12px;">Assinatura do Contratante</span></div></body></html>');
            printWindow.document.close();
        };

        async function renderContratantes() {
            const tbody = document.getElementById('contratante-list-body');
            tbody.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";
            const snap = await getDocs(collection(db, "clients_contracts"));
            tbody.innerHTML = "";
            
            const canEdit = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.can_edit_reports);

            snap.forEach(d => {
                const c = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${c.nome}</b></td>
                    <td>${c.cpf || '-'}</td>
                    <td>${c.celular || '-'}</td>
                    <td>
                        <div class="action-group">
                            ${canEdit ? `<button class="btn-icon btn-edit" onclick="editContratante('${d.id}')" title="Editar"><span class="material-icons-round">edit</span></button>` : ''}
                            <button class="btn-icon btn-print" onclick="printContratante('${d.id}')" title="Imprimir"><span class="material-icons-round">print</span></button>
                            ${canEdit ? `<button class="btn-icon btn-delete" onclick="deleteContratante('${d.id}')" title="Excluir"><span class="material-icons-round">delete</span></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- DADOS DA OBRA/SERVIÇO (TAP) ---
        window.showTapPanel = (filterType) => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('tap-panel').style.display = 'block';
            renderTAP();
        };

        window.handleSaveTAP = async () => {
            const data = {
                name: document.getElementById('tap-name').value,
                type: document.getElementById('tap-type').value,
                status: document.getElementById('tap-status').value,
                contractId: document.getElementById('tap-contract-id').value,
                contractVal: document.getElementById('tap-contract-value').value,
                clientName: document.getElementById('tap-client-name').value,
                clientContact: document.getElementById('tap-client-contact').value,
                description: document.getElementById('tap-description').value,
                obs: document.getElementById('tap-obs').value,
                createdBy: currentUser.email
            };
            if(!data.name) return alert("Nome da Obra é obrigatório");
            await addDoc(collection(db, "projects"), data);
            await logAction("TAP_Dados", `Criou Dados: ${data.name}`);
            alert("Salvo!");
            document.getElementById('tap-name').value = '';
            renderTAP();
        };

        async function renderTAP() {
            const tbody = document.getElementById('tap-list-body');
            tbody.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";
            const snap = await getDocs(collection(db, "projects"));
            tbody.innerHTML = "";
            
            const canEdit = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.can_edit_reports);

            snap.forEach(d => {
                const p = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${p.name}</td><td>${p.clientName || '-'}</td><td><span class="badge badge-active">${p.status}</span></td><td>${canEdit ? `<button class="btn-icon btn-delete" onclick="deleteTAP('${d.id}')"><span class="material-icons-round">delete</span></button>` : '-'}</td>`;
                tbody.appendChild(tr);
            });
        }

        window.deleteTAP = async (id) => {
            const r = prompt("Motivo?"); if(!r) return;
            if(confirm("Confirma?")) { await deleteDoc(doc(db, "projects", id)); await logAction("TAP_Dados", `Excluiu ID: ${id} | Motivo: ${r}`); renderTAP(); }
        };

        // --- DIÁRIOS ---
        window.showDiariesPanel = async () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('diaries-panel').style.display = 'block';
            const sel = document.getElementById('report-project-select');
            sel.innerHTML = '<option value="">Selecione a Obra...</option>';
            const snap = await getDocs(collection(db, "projects"));
            snap.forEach(d => { const opt = document.createElement('option'); opt.value = d.data().name; opt.text = d.data().name; sel.appendChild(opt); });
            renderDiaries();
        };

        window.handleSaveDiary = async () => {
            const date = document.getElementById('report-date').value;
            const project = document.getElementById('report-project-select').value;
            const desc = document.getElementById('report-desc').value;
            
            const photo = document.getElementById('report-photo').value;
            const obs = document.getElementById('report-obs').value;

            if(!date || !project || !desc) return alert("Preencha todos os dados básicos");
            
            await addDoc(collection(db, "daily_reports"), { date, project, desc, photo, obs, author: currentUser.email });
            await logAction("Diário", `Novo relatório: ${project}`);
            alert("Registrado com sucesso!");
            
            document.getElementById('report-desc').value = '';
            document.getElementById('report-photo').value = '';
            document.getElementById('report-obs').value = '';
            
            renderDiaries();
        };

        async function renderDiaries() {
            const tbody = document.getElementById('diaries-list-body');
            tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
            const snap = await getDocs(collection(db, "daily_reports"));
            tbody.innerHTML = "";
            
            const canEdit = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.can_edit_reports);

            snap.forEach(d => {
                const r = d.data();
                const tr = document.createElement('tr');
                
                const obsText = r.obs ? `<div style="font-size:0.75rem; color:var(--secondary); margin-top:4px;">Obs: ${r.obs}</div>` : '';
                const photoIcon = r.photo ? `<button class="btn-icon" style="background:#E0F2FE; color:#0284C7; width:30px; height:30px; display:inline-flex; margin-right:5px;" onclick="window.open('${r.photo}', '_blank')" title="Ver Foto"><span class="material-icons-round" style="font-size:18px;">photo_camera</span></button>` : '';

                tr.innerHTML = `
                    <td>${r.date}</td>
                    <td>${r.project}</td>
                    <td><small>${r.author}</small></td>
                    <td><div style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.desc}</div>${obsText}</td>
                    <td>
                        <div style="display:flex; align-items:center;">
                            ${photoIcon}
                            ${canEdit ? `<button class="btn-icon btn-delete" onclick="deleteDiary('${d.id}')"><span class="material-icons-round">delete</span></button>` : ''}
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        window.deleteDiary = async (id) => {
            const r = prompt("Motivo?"); if(!r) return;
            if(confirm("Confirma?")) { await deleteDoc(doc(db, "daily_reports", id)); await logAction("Diário", `Excluiu ID: ${id} | Motivo: ${r}`); renderDiaries(); }
        };

        // --- NOVA OCORRÊNCIA ---
        window.showOccurrencesPanel = async () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('occurrences-panel').style.display = 'block';
            
            const sel = document.getElementById('occ-project-select');
            sel.innerHTML = '<option value="">Selecione a Obra...</option>';
            
            const snap = await getDocs(collection(db, "construction_sites"));
            snap.forEach(d => { const opt = document.createElement('option'); opt.value = d.data().name; opt.text = d.data().name; sel.appendChild(opt); });
            
            renderOccurrences();
        };

        window.handleSaveOccurrence = async () => {
            const date = document.getElementById('occ-date').value;
            const project = document.getElementById('occ-project-select').value;
            const obs = document.getElementById('occ-obs').value;
            const fileInput = document.getElementById('occ-photo');
            const file = fileInput.files[0];

            if(!date || !project || !obs) return alert("Preencha Data, Obra e Observação.");

            const btn = document.getElementById('btn-save-occ');
            const originalText = btn.innerText;
            btn.innerText = "Registrando..."; btn.disabled = true;

            const saveToDb = async (photoBase64) => {
                try {
                    await addDoc(collection(db, "occurrences"), { date, project, obs, photo: photoBase64 || "", author: currentUser.email, timestamp: new Date().toISOString() });
                    await logAction("Ocorrência", `Nova ocorrência: ${project}`);
                    alert("Ocorrência registrada com sucesso!");
                    
                    document.getElementById('occ-date').value = ''; document.getElementById('occ-project-select').value = ''; document.getElementById('occ-obs').value = ''; fileInput.value = '';
                    renderOccurrences();
                } catch(e) { console.error(e); alert("Erro ao salvar ocorrência."); } finally { btn.innerText = originalText; btn.disabled = false; }
            };

            if (file) {
                if(file.size > 800000) { alert("A imagem é muito grande para esta demonstração (Max 800KB)."); btn.innerText = originalText; btn.disabled = false; return; }
                const reader = new FileReader();
                reader.onload = (e) => saveToDb(e.target.result);
                reader.onerror = () => { alert("Erro ao ler foto."); btn.innerText = originalText; btn.disabled = false; };
                reader.readAsDataURL(file);
            } else { saveToDb(""); }
        };

        async function renderOccurrences() {
            const tbody = document.getElementById('occurrences-list-body');
            tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
            const snap = await getDocs(collection(db, "occurrences"));
            tbody.innerHTML = "";
            
            const canEdit = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.can_edit_reports);

            snap.forEach(d => {
                const r = d.data();
                const tr = document.createElement('tr');
                const photoIcon = r.photo ? `<button class="btn-icon" style="background:#FEE2E2; color:#DC2626; width:30px; height:30px; display:inline-flex; margin-right:5px;" onclick="viewFileFullscreen('${r.photo}', 'Ocorrência: ${r.project}')" title="Ver Foto"><span class="material-icons-round" style="font-size:18px;">photo_camera</span></button>` : '';

                tr.innerHTML = `
                    <td>${r.date}</td>
                    <td>${r.project}</td>
                    <td><small>${r.author}</small></td>
                    <td><div style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${r.obs}</div></td>
                    <td>
                        <div style="display:flex; align-items:center;">
                            ${photoIcon}
                            ${canEdit ? `<button class="btn-icon btn-delete" onclick="deleteOccurrence('${d.id}')"><span class="material-icons-round">delete</span></button>` : ''}
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        window.deleteOccurrence = async (id) => {
            const r = prompt("Motivo da exclusão da ocorrência?"); if(!r) return;
            if(confirm("Confirma a exclusão definitiva?")) { await deleteDoc(doc(db, "occurrences", id)); await logAction("Ocorrência", `Excluiu ID: ${id} | Motivo: ${r}`); renderOccurrences(); }
        };

        // --- GESTÃO DE OBRAS ---
        window.showManagementPanel = async () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('management-panel').style.display = 'block';
            await populateManagementSelects();
            renderManagementWorks();
        };

        async function populateManagementSelects() {
            const engBox = document.getElementById('mgmt-engineers-box');
            const fiscBox = document.getElementById('mgmt-fiscals-box');
            const archBox = document.getElementById('mgmt-architects-box');
            
            engBox.innerHTML = '<span style="color:var(--secondary); font-size:0.8rem;">Carregando...</span>';
            fiscBox.innerHTML = '<span style="color:var(--secondary); font-size:0.8rem;">Carregando...</span>';
            archBox.innerHTML = '<span style="color:var(--secondary); font-size:0.8rem;">Carregando...</span>';
            
            const users = await getDocs(collection(db, "users"));
            
            engBox.innerHTML = '';
            fiscBox.innerHTML = '';
            archBox.innerHTML = '';
            
            let engCount = 0; let fiscCount = 0; let archCount = 0;

            users.forEach(d => {
                const u = d.data();
                const label = `${u.email.split('@')[0]} ${u.whatsapp ? `(${u.whatsapp})` : ''}`;
                
                if (u.role === 'engenheiro' || u.role === 'admin') { 
                    engCount++;
                    const chip = document.createElement('div');
                    chip.className = 'selection-chip'; chip.setAttribute('data-value', label);
                    chip.innerHTML = `<span class="material-icons-round chip-icon" style="font-size:16px;">person</span> ${label}`;
                    chip.onclick = function() { this.classList.toggle('selected'); };
                    engBox.appendChild(chip);
                }
                
                if (u.role === 'fiscal' || u.role === 'admin') { 
                    fiscCount++;
                    const chip = document.createElement('div');
                    chip.className = 'selection-chip'; chip.setAttribute('data-value', label);
                    chip.innerHTML = `<span class="material-icons-round chip-icon" style="font-size:16px;">visibility</span> ${label}`;
                    chip.onclick = function() { this.classList.toggle('selected'); };
                    fiscBox.appendChild(chip);
                }

                if (u.role === 'arquiteto' || u.role === 'admin') { 
                    archCount++;
                    const chip = document.createElement('div');
                    chip.className = 'selection-chip'; chip.setAttribute('data-value', label);
                    chip.innerHTML = `<span class="material-icons-round chip-icon" style="font-size:16px;">architecture</span> ${label}`;
                    chip.onclick = function() { this.classList.toggle('selected'); };
                    archBox.appendChild(chip);
                }
            });

            if(engCount === 0) engBox.innerHTML = '<span style="color:var(--secondary); font-size:0.8rem;">Nenhum engenheiro encontrado.</span>';
            if(fiscCount === 0) fiscBox.innerHTML = '<span style="color:var(--secondary); font-size:0.8rem;">Nenhum fiscal encontrado.</span>';
            if(archCount === 0) archBox.innerHTML = '<span style="color:var(--secondary); font-size:0.8rem;">Nenhum arquiteto encontrado.</span>';
        }

        function getSelectedChips(containerId) {
            const container = document.getElementById(containerId);
            const selected = container.querySelectorAll('.selection-chip.selected');
            return Array.from(selected).map(el => el.getAttribute('data-value')).join(', ');
        }

        window.handleSaveManagementWork = async () => {
            const name = document.getElementById('mgmt-name').value;
            const fileInput = document.getElementById('mgmt-photo-input');
            const file = fileInput.files[0];
            const engineers = getSelectedChips('mgmt-engineers-box');
            const fiscals = getSelectedChips('mgmt-fiscals-box');
            const architects = getSelectedChips('mgmt-architects-box');
            const permit = document.getElementById('mgmt-permit').value;
            const license = document.getElementById('mgmt-license').value;
            const valContract = document.getElementById('mgmt-val-contract').value;
            const valMeasured = document.getElementById('mgmt-val-measured').value;
            const startDate = document.getElementById('mgmt-start-date').value;
            const endDate = document.getElementById('mgmt-end-date').value;

            if(!name) return alert("Nome da Obra é obrigatório!");

            const saveToDb = async (photoBase64) => {
                try {
                    const data = { name, photo: photoBase64 || "", engineers, fiscals, architects, permit, license, valContract, valMeasured, startDate, endDate, createdBy: currentUser.email };
                    
                    if (editingManagementId) {
                        await updateDoc(doc(db, "construction_sites", editingManagementId), data);
                        await logAction("Gestão Obras", `Atualizou obra: ${name}`);
                        alert("Obra Atualizada!");
                    } else {
                        if(!photoBase64) data.photo = "";
                        await addDoc(collection(db, "construction_sites"), data);
                        await logAction("Gestão Obras", `Cadastrou obra: ${name}`);
                        alert("Obra Salva!");
                    }
                    cancelEditManagementWork();
                    renderManagementWorks();
                } catch(e) { console.error(e); alert("Erro ao salvar no banco."); }
            };

            if (file) {
                if(file.size > 800000) return alert("A imagem é muito grande (Max 800KB).");
                const reader = new FileReader();
                reader.onload = (e) => saveToDb(e.target.result);
                reader.onerror = () => alert("Erro ao ler arquivo");
                reader.readAsDataURL(file);
            } else { saveToDb(""); }
        };

        window.editManagementWork = async (id) => {
            const snap = await getDoc(doc(db, "construction_sites", id));
            if(!snap.exists()) return;
            const w = snap.data();
            editingManagementId = id;

            document.getElementById('mgmt-name').value = w.name || '';
            document.getElementById('mgmt-permit').value = w.permit || '';
            document.getElementById('mgmt-license').value = w.license || '';
            document.getElementById('mgmt-val-contract').value = w.valContract || '';
            document.getElementById('mgmt-val-measured').value = w.valMeasured || '';
            document.getElementById('mgmt-start-date').value = w.startDate || '';
            document.getElementById('mgmt-end-date').value = w.endDate || '';

            const selectChips = (boxId, savedString) => {
                const box = document.getElementById(boxId);
                const chips = box.querySelectorAll('.selection-chip');
                const savedArr = savedString ? savedString.split(',').map(s => s.trim()) : [];
                chips.forEach(c => {
                    if (savedArr.includes(c.getAttribute('data-value'))) {
                        c.classList.add('selected');
                    } else {
                        c.classList.remove('selected');
                    }
                });
            };

            selectChips('mgmt-engineers-box', w.engineers);
            selectChips('mgmt-fiscals-box', w.fiscals);
            selectChips('mgmt-architects-box', w.architects);

            document.getElementById('btn-save-mgmt').innerText = "Atualizar Detalhes";
            document.getElementById('btn-cancel-mgmt').style.display = "inline-block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelEditManagementWork = () => {
            editingManagementId = null;
            document.getElementById('mgmt-name').value = '';
            document.getElementById('mgmt-permit').value = '';
            document.getElementById('mgmt-license').value = '';
            document.getElementById('mgmt-val-contract').value = '';
            document.getElementById('mgmt-val-measured').value = '';
            document.getElementById('mgmt-start-date').value = '';
            document.getElementById('mgmt-end-date').value = '';
            document.getElementById('mgmt-photo-input').value = '';
            document.querySelectorAll('#management-panel .selection-chip').forEach(c => c.classList.remove('selected'));

            document.getElementById('btn-save-mgmt').innerText = "Salvar Detalhes";
            document.getElementById('btn-cancel-mgmt').style.display = "none";
        };

        async function renderManagementWorks() {
            const tbody = document.getElementById('management-list-body'); tbody.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";
            const snap = await getDocs(collection(db, "construction_sites")); tbody.innerHTML = "";
            
            const canEdit = currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.can_edit_reports);

            snap.forEach(d => {
                const w = d.data();
                const tr = document.createElement('tr');
                const datesStr = (w.startDate && w.endDate) ? `<small>Início: ${w.startDate.split('-').reverse().join('/')}<br>Fim: ${w.endDate.split('-').reverse().join('/')}</small>` : '-';
                tr.innerHTML = `
                    <td>${w.name}</td>
                    <td>${datesStr}</td>
                    <td>${w.engineers || '-'}</td>
                    <td>${w.fiscals || '-'}</td>
                    <td>${w.architects || '-'}</td>
                    <td>
                        <div class="action-group">
                            ${canEdit ? `<button class="btn-icon btn-edit" onclick="editManagementWork('${d.id}')" title="Editar"><span class="material-icons-round">edit</span></button>
                            <button class="btn-icon btn-delete" onclick="deleteManagementWork('${d.id}')" title="Excluir"><span class="material-icons-round">delete</span></button>` : '-'}
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        window.deleteManagementWork = async (id) => {
            const r = prompt("Motivo da exclusão?"); if(!r) return;
            if(confirm("Confirma?")) { await deleteDoc(doc(db, "construction_sites", id)); await logAction("Gestão", `Excluiu ID: ${id} | Motivo: ${r}`); renderManagementWorks(); }
        };

        // --- FUNCIONÁRIOS ---
        window.showEmployeesPanel = async () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('employees-panel').style.display = 'block';
            const sel = document.getElementById('emp-project-select'); sel.innerHTML = '<option value="">Selecione a Obra...</option>';
            const q = query(collection(db, "projects"), where("status", "==", "Em Andamento"));
            const snap = await getDocs(q);
            snap.forEach(d => { const opt = document.createElement('option'); opt.value = d.data().name; opt.text = d.data().name; sel.appendChild(opt); });
            renderEmployees();
        };

        window.handleSaveEmployee = async () => {
            const name = document.getElementById('emp-name').value;
            const role = document.getElementById('emp-role').value;
            const work = document.getElementById('emp-project-select').value;
            if(!name || !work) return alert("Nome e Obra são obrigatórios!");
            
            if(editingEmployeeId) {
                await updateDoc(doc(db, "workforce", editingEmployeeId), { name, role, work });
                editingEmployeeId = null;
                document.getElementById('btn-save-employee').innerText = "Cadastrar Funcionário";
            } else {
                await addDoc(collection(db, "workforce"), { name, role, work, registeredBy: currentUser.email });
            }
            alert("Salvo!"); document.getElementById('emp-name').value = ''; renderEmployees();
        };

        window.editEmployee = (id, name, role, work) => {
            editingEmployeeId = id; document.getElementById('emp-name').value = name; document.getElementById('emp-role').value = role; document.getElementById('emp-project-select').value = work; document.getElementById('btn-save-employee').innerText = "Atualizar";
        };

        async function renderEmployees() {
            const tbody = document.getElementById('employees-list-body'); tbody.innerHTML = "<tr><td colspan='4'>Carregando...</td></tr>";
            const snap = await getDocs(collection(db, "workforce")); tbody.innerHTML = "";
            snap.forEach(d => {
                const e = d.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${e.name}</td><td>${e.role || '-'}</td><td><span class="badge badge-active">${e.work}</span></td><td><div class="action-group"><button class="btn-icon btn-edit" onclick="editEmployee('${d.id}', '${e.name}', '${e.role}', '${e.work}')"><span class="material-icons-round">edit</span></button><button class="btn-icon btn-delete" onclick="deleteEmployee('${d.id}')"><span class="material-icons-round">delete</span></button></div></td>`;
                tbody.appendChild(tr);
            });
        }

        window.deleteEmployee = async (id) => {
            const r = prompt("Motivo?"); if(!r) return;
            if(confirm("Remover?")) { await deleteDoc(doc(db, "workforce", id)); await logAction("Funcionário", `Excluiu ID: ${id} | Motivo: ${r}`); renderEmployees(); }
        };

        // --- ALMOXARIFADO ---
        window.showWarehousePanel = async () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('warehouse-panel').style.display = 'block';

            if(currentUser.role === 'admin') {
                document.getElementById('wh-admin-controls').style.display = 'block';
                const pSel = document.getElementById('assign-wh-project'); const uSel = document.getElementById('assign-wh-user');
                pSel.innerHTML = '<option value="">Carregando...</option>'; uSel.innerHTML = '<option value="">Carregando...</option>';
                
                const pSnap = await getDocs(collection(db, "construction_sites")); pSel.innerHTML = '<option value="">Selecione Obra...</option>';
                pSnap.forEach(d => { const o = document.createElement('option'); o.value = d.id; o.text = d.data().name; pSel.appendChild(o); });

                const uSnap = await getDocs(query(collection(db, "users"), where("role", "==", "almoxarifado"))); uSel.innerHTML = '<option value="">Selecione Almoxarife...</option>';
                uSnap.forEach(d => { const o = document.createElement('option'); o.value = d.id; o.text = d.data().email; uSel.appendChild(o); });
                renderAssignmentsList();
            } else { document.getElementById('wh-admin-controls').style.display = 'none'; }

            await populateWarehouseProjects(); updateWarehouseDashboard();
            
            const empSel = document.getElementById('wd-employee-select'); empSel.innerHTML = '<option value="">Carregando...</option>';
            const emps = await getDocs(collection(db, "workforce")); empSel.innerHTML = '<option value="">Selecione Funcionário...</option>';
            emps.forEach(d => { const o = document.createElement('option'); o.value = d.id; o.text = `${d.data().name} (${d.data().work})`; empSel.appendChild(o); });

            const itemSel = document.getElementById('wd-item-select'); itemSel.innerHTML = '<option value="">Carregando...</option>';
            const items = await getDocs(collection(db, "inventory")); itemSel.innerHTML = '<option value="">Selecione Item...</option>';
            items.forEach(d => {
                const i = d.data();
                if(i.qty > 0) { const o = document.createElement('option'); o.value = d.id; o.text = `${i.name} (Disp: ${i.qty} ${i.unit})`; itemSel.appendChild(o); }
            });
        };

        window.assignWarehouseManager = async () => {
            const projectId = document.getElementById('assign-wh-project').value; const userId = document.getElementById('assign-wh-user').value;
            if(!projectId || !userId) return alert("Selecione ambos!");
            const userSnap = await getDoc(doc(db, "users", userId)); const userEmail = userSnap.data().email;
            await updateDoc(doc(db, "construction_sites", projectId), { warehouseManager: userEmail });
            await logAction("Almoxarifado", `Atribuiu ${userEmail} para obra ID: ${projectId}`);
            alert("Vinculado com sucesso!"); renderAssignmentsList();
        };

        async function renderAssignmentsList() {
            const div = document.getElementById('wh-assignments-list'); div.innerHTML = "Carregando...";
            const userMap = {}; const uSnap = await getDocs(query(collection(db, "users"), where("role", "==", "almoxarifado")));
            uSnap.forEach(u => userMap[u.data().email] = u.id);

            const snap = await getDocs(collection(db, "construction_sites")); div.innerHTML = "<h5 style='margin-top:10px; color:var(--secondary)'>Vínculos Ativos:</h5>";
            if(snap.empty) { div.innerHTML += "<small>Nenhum.</small>"; return; }

            snap.forEach(d => {
                const p = d.data();
                if(p.warehouseManager) {
                    const mgrId = userMap[p.warehouseManager] || ''; 
                    div.innerHTML += `<div style="display:flex; justify-content:space-between; align-items:center; background:#F8FAFC; padding:8px; margin-bottom:5px; border-radius:8px; border:1px solid #E2E8F0;"><div><b>${p.name}</b> <br> <small>${p.warehouseManager}</small></div><button class="btn-icon btn-edit" style="width:30px; height:30px;" onclick="editAssignment('${d.id}', '${mgrId}')" title="Editar Vínculo"><span class="material-icons-round" style="font-size:16px;">edit</span></button></div>`;
                }
            });
        }
        
        window.editAssignment = (projId, userId) => { document.getElementById('assign-wh-project').value = projId; document.getElementById('assign-wh-user').value = userId; document.getElementById('assign-wh-project').focus(); };

        async function populateWarehouseProjects() {
            const sel = document.getElementById('wh-view-project'); const addSel = document.getElementById('wh-project-select');
            sel.innerHTML = ''; addSel.innerHTML = '<option value="">Selecione a Obra de Destino...</option>';

            if (currentUser.role === 'admin') { sel.innerHTML += '<option value="all">Todas as Obras (Geral)</option>'; }

            const snap = await getDocs(collection(db, "construction_sites"));
            snap.forEach(d => {
                const p = d.data(); let allowed = false;
                if (currentUser.role === 'admin') allowed = true; else if (p.warehouseManager === currentUser.email) allowed = true;
                if(allowed) {
                    const opt1 = document.createElement('option'); opt1.value = p.name; opt1.text = p.name; sel.appendChild(opt1);
                    const opt2 = document.createElement('option'); opt2.value = p.name; opt2.text = p.name; addSel.appendChild(opt2);
                }
            });
            if(sel.options.length > 0) { sel.selectedIndex = 0; } else { sel.innerHTML = '<option value="">Nenhuma obra vinculada.</option>'; }
        }

        window.updateWarehouseDashboard = async () => {
            const filter = document.getElementById('wh-view-project').value; if(!filter) return;

            const items = []; const qInv = query(collection(db, "inventory")); const snapInv = await getDocs(qInv);
            snapInv.forEach(d => { const data = d.data(); if(filter === 'all' || data.project === filter) { items.push({...data, id: d.id}); } });

            document.getElementById('stat-total-items').innerText = items.length; const lowStock = items.filter(i => i.qty <= 5).length; document.getElementById('stat-low-stock').innerText = lowStock;

            const listTools = document.getElementById('wh-list-tools'); const listConsumables = document.getElementById('wh-list-consumables');
            listTools.innerHTML = ""; listConsumables.innerHTML = "";

            items.forEach(item => {
                const isLow = item.qty <= 5; const badgeClass = isLow ? 'badge-danger' : 'badge-active'; const warningIcon = isLow ? '<span class="material-icons-round" style="color:red; font-size:16px; vertical-align:middle;">warning</span>' : '';
                const row = `<tr><td>${item.name} <br><small style="color:var(--secondary)">${item.project || 'Geral'}</small></td><td><small>${item.type}/${item.category}</small></td><td>${warningIcon} <span class="badge ${badgeClass}">${item.qty} ${item.unit}</span></td><td><button class="btn-icon btn-edit" onclick="editInventoryItem('${item.id}', '${item.name}', '${item.type}', '${item.category}', '${item.qty}', '${item.unit}', '${item.project}')"><span class="material-icons-round">edit</span></button> <button class="btn-icon btn-delete" onclick="deleteInventoryItem('${item.id}')"><span class="material-icons-round">delete</span></button></td></tr>`;
                if(item.type === 'Ferramenta' || item.type === 'Equipamento') { listTools.innerHTML += row; } else { listConsumables.innerHTML += row; }
            });
        };

        window.switchWarehouseTab = (tab) => {
            const btns = document.querySelectorAll('.tab-btn'); btns.forEach(b => b.classList.remove('active'));
            if(tab === 'stock') { document.getElementById('view-stock').style.display = 'block'; document.getElementById('view-withdrawals').style.display = 'none'; btns[0].classList.add('active'); } 
            else { document.getElementById('view-stock').style.display = 'none'; document.getElementById('view-withdrawals').style.display = 'block'; btns[1].classList.add('active'); renderWithdrawals(); }
        };

        window.handleSaveInventory = async () => {
            const name = document.getElementById('wh-name').value; const project = document.getElementById('wh-project-select').value; const type = document.getElementById('wh-type').value; const category = document.getElementById('wh-category').value; const qty = parseFloat(document.getElementById('wh-qty').value); const unit = document.getElementById('wh-unit').value;
            if(!name || isNaN(qty)) return alert("Preencha corretamente!");
            await addDoc(collection(db, "inventory"), { name, project, type, category, qty, unit, registeredBy: currentUser.email });
            await logAction("Almoxarifado", `Cadastrou: ${name} (+${qty}${unit})`); alert("Item Adicionado!"); updateWarehouseDashboard();
        };
        
        window.editInventoryItem = (id, name, type, cat, qty, unit, proj) => {
            document.getElementById('wh-name').value = name; document.getElementById('wh-type').value = type; document.getElementById('wh-category').value = cat; document.getElementById('wh-qty').value = qty; document.getElementById('wh-unit').value = unit; document.getElementById('wh-project-select').value = proj || ""; alert("Modo edição ativado.");
        };

        window.deleteInventoryItem = async (id) => {
            const r = prompt("Motivo da exclusão?"); if(!r) return;
            if(confirm("Excluir item?")) { await deleteDoc(doc(db, "inventory", id)); await logAction("Almoxarifado", `Excluiu ID: ${id} | Motivo: ${r}`); updateWarehouseDashboard(); }
        };

        window.handleWithdrawal = async () => {
            const empId = document.getElementById('wd-employee-select').value; const itemId = document.getElementById('wd-item-select').value; const qty = parseFloat(document.getElementById('wd-qty').value);
            if(!empId || !itemId || !qty || qty <= 0) return alert("Preencha tudo!");
            const itemRef = doc(db, "inventory", itemId); const itemSnap = await getDoc(itemRef);
            if(!itemSnap.exists()) return alert("Item não existe!");
            const currentQty = itemSnap.data().qty; if(currentQty < qty) return alert(`Estoque insuficiente! Disponível: ${currentQty}`);
            const empSnap = await getDoc(doc(db, "workforce", empId));
            await addDoc(collection(db, "warehouse_movements"), { itemId, itemName: itemSnap.data().name, empId, empName: empSnap.data().name, qty, unit: itemSnap.data().unit, date: new Date().toISOString(), status: 'active' });
            await updateDoc(itemRef, { qty: currentQty - qty }); await logAction("Almoxarifado", `Retirada: ${itemSnap.data().name} (${qty}) por ${empSnap.data().name}`);
            alert("Retirada Registrada!"); showWarehousePanel();
        };

        async function renderWithdrawals() {
            const tbody = document.getElementById('wd-list-body'); tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";
            const q = query(collection(db, "warehouse_movements"), where("status", "==", "active")); const snap = await getDocs(q); tbody.innerHTML = "";
            if(snap.empty) { tbody.innerHTML = "<tr><td colspan='5' style='text-align:center'>Nenhum empréstimo ativo.</td></tr>"; return; }
            snap.forEach(d => {
                const mov = d.data(); const tr = document.createElement('tr');
                tr.innerHTML = `<td>${mov.empName}</td><td>${mov.itemName}</td><td>${mov.qty} ${mov.unit}</td><td>${new Date(mov.date).toLocaleDateString()}</td><td><button class="btn-icon btn-edit" style="background:#DCFCE7; color:green;" onclick="returnItem('${d.id}', '${mov.itemId}', ${mov.qty})">Devolver</button></td>`;
                tbody.appendChild(tr);
            });
        }

        window.returnItem = async (movId, itemId, qty) => {
            if(!confirm("Confirmar devolução ao estoque?")) return;
            await deleteDoc(doc(db, "warehouse_movements", movId));
            const itemRef = doc(db, "inventory", itemId); const itemSnap = await getDoc(itemRef);
            if(itemSnap.exists()) { await updateDoc(itemRef, { qty: itemSnap.data().qty + qty }); }
            await logAction("Almoxarifado", `Devolução: ${itemSnap.data().name} (+${qty})`); renderWithdrawals();
        };

        // --- COMUNICAÇÃO ---
        window.showCommunicationPanel = async () => {
            hideAllPanels(); checkMobileClose();
            document.getElementById('communication-panel').style.display = 'block';
            const sel = document.getElementById('chat-project-select'); sel.innerHTML = '<option value="">Selecione a Obra...</option>';
            const snap = await getDocs(collection(db, "projects"));
            snap.forEach(d => { const opt = document.createElement('option'); opt.value = d.data().name; opt.text = d.data().name; sel.appendChild(opt); });
        };

        window.loadProjectChat = async () => {
            const project = document.getElementById('chat-project-select').value; const area = document.getElementById('chat-messages-area');
            if (!project) { area.innerHTML = '<p style="text-align: center; margin-top: 50px;">Selecione uma obra.</p>'; return; }
            area.innerHTML = '<p style="text-align: center; margin-top: 20px;">Carregando...</p>';
            const q = query(collection(db, "project_chats"), where("project", "==", project), orderBy("timestamp")); const snap = await getDocs(q); area.innerHTML = '';
            snap.forEach(d => {
                const msg = d.data(); const isMe = msg.user === currentUser.email; const div = document.createElement('div');
                div.className = `message-bubble ${isMe ? 'msg-me' : 'msg-other'}`; div.innerHTML = `<div>${msg.message}</div><div class="msg-meta">${isMe ? 'Você' : msg.user.split('@')[0]}</div>`;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        };

        window.sendMessage = async () => {
            const project = document.getElementById('chat-project-select').value; const input = document.getElementById('chat-input'); const message = input.value.trim();
            if(!project || !message) return;
            await addDoc(collection(db, "project_chats"), { project, user: currentUser.email, message, timestamp: new Date().toISOString() });
            input.value = ''; loadProjectChat();
        };

        // --- ADMIN PANELS ---
        window.showAdminPanel = () => { if(currentUser.role!=='admin')return; hideAllPanels(); checkMobileClose(); document.getElementById('admin-panel').style.display='block'; renderUserList(); };
        window.showSettingsPanel = async () => { if(currentUser.role==='admin' || (currentUser.permissions && currentUser.permissions.access_settings)) { hideAllPanels(); checkMobileClose(); document.getElementById('settings-panel').style.display='block'; await populateUserSelect(); } };
        window.showAuditPanel = () => { if(currentUser.role!=='admin')return; hideAllPanels(); checkMobileClose(); document.getElementById('audit-panel').style.display='block'; renderAuditLogs(); };

        async function renderUserList() {
            const tbody = document.getElementById('user-list-body'); tbody.innerHTML = "<tr><td>Carregando...</td></tr>";
            const snap = await getDocs(collection(db, "users")); tbody.innerHTML = "";
            snap.forEach(d => {
                const u = d.data(); const r = roleConfig[u.role] || roleConfig['user']; const tr = document.createElement('tr');
                tr.innerHTML = `<td>${u.email}</td><td>${u.whatsapp ? `<a href="https://wa.me/55${u.whatsapp.replace(/\D/g,'')}" target="_blank" style="text-decoration:none; color:inherit;">${u.whatsapp} <span class="material-icons-round" style="font-size:14px; color:green">chat</span></a>` : '-'}</td><td><button class="btn-icon btn-view" onclick="alert('${u.pass}')"><span class="material-icons-round">visibility</span></button></td><td><span class="badge" style="background:${r.color}; color:${r.text}">${r.label}</span></td><td><div class="action-group"><button class="btn-icon btn-perm" onclick="goToPermissions('${d.id}')" title="Permissões"><span class="material-icons-round">vpn_key</span></button><button class="btn-icon btn-edit" onclick="editUser('${d.id}','${u.email}','${u.pass}','${u.role}','${u.whatsapp||''}')"><span class="material-icons-round">edit</span></button><button class="btn-icon btn-delete" onclick="delUser('${d.id}')"><span class="material-icons-round">delete</span></button></div></td>`;
                tbody.appendChild(tr);
            });
        }

        window.handleSaveUser = async () => {
            const email = document.getElementById('new-user-email').value; const pass = document.getElementById('new-user-pass').value; const role = document.getElementById('new-user-role').value; const whatsapp = document.getElementById('new-user-whatsapp').value;
            if(!email || !pass) return alert("Preencha tudo");
            try {
                if(editingUserId) {
                    const r = prompt("Motivo da alteração?"); if(!r) return;
                    await updateDoc(doc(db, "users", editingUserId), { email, pass, role, whatsapp }); await logAction("Edição", `User: ${email} | Motivo: ${r}`); cancelEdit();
                } else {
                    const q = query(collection(db, "users"), where("email", "==", email)); if(!(await getDocs(q)).empty) return alert("Email existe");
                    await addDoc(collection(db, "users"), { email, pass, role, whatsapp }); await logAction("Cadastro", `Criou: ${email}`);
                }
                renderUserList(); document.getElementById('new-user-email').value = ''; document.getElementById('new-user-pass').value = ''; document.getElementById('new-user-whatsapp').value = '';
            } catch(e) { console.error(e); }
        };

        window.editUser = (id, e, p, r, w) => { editingUserId = id; document.getElementById('new-user-email').value = e; document.getElementById('new-user-pass').value = p; document.getElementById('new-user-role').value = r; document.getElementById('new-user-whatsapp').value = w; document.getElementById('btn-add-user').innerText = "Salvar"; document.getElementById('btn-cancel-edit').style.display = 'block'; };
        window.cancelEdit = () => { editingUserId = null; document.getElementById('new-user-email').value = ''; document.getElementById('new-user-pass').value = ''; document.getElementById('new-user-whatsapp').value = ''; document.getElementById('btn-add-user').innerText = "Criar Acesso"; document.getElementById('btn-cancel-edit').style.display = 'none'; };

        window.delUser = async (id) => { const r = prompt("Motivo da exclusão?"); if(!r) return; if(confirm("Confirma?")) { await deleteDoc(doc(db, "users", id)); await logAction("Exclusão", `ID: ${id}`); renderUserList(); } };

        // --- AUDIT & SETTINGS ---
        async function renderAuditLogs() {
            const tb = document.getElementById('audit-list-body'); tb.innerHTML = "<tr><td>Carregando...</td></tr>";
            const s = await getDocs(collection(db, "audit_logs")); allAuditLogs = []; s.forEach(d => allAuditLogs.push({id: d.id, ...d.data()}));
            allAuditLogs.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp)); filterAuditLogs();
        }

        window.filterAuditLogs = () => {
            const term = document.getElementById('audit-search').value.toLowerCase(); const tb = document.getElementById('audit-list-body'); tb.innerHTML = "";
            const filtered = allAuditLogs.filter(l => (l.userEmail && l.userEmail.toLowerCase().includes(term)) || (l.action && l.action.toLowerCase().includes(term)) || (l.details && l.details.toLowerCase().includes(term)));
            filtered.forEach(x => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="log-time">${new Date(x.timestamp).toLocaleString()}</td><td>${x.userEmail}</td><td class="log-action">${x.action}</td><td>${x.details}</td>`; tb.appendChild(tr); });
        };

        window.printAuditLogs = () => {
            const tableContent = document.getElementById('audit-list-body').innerHTML; 
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Relatório de Auditoria</title><style>body{font-family:sans-serif;} table{width:100%; border-collapse:collapse; margin-top:20px;} th,td{border:1px solid #000; padding:8px; text-align:left; font-size:12px;} th{background:#f0f0f0;}</style></head>');
            printWindow.document.write('<body onload="setTimeout(function(){window.print(); window.close();}, 500);"><h2>Relatório de Auditoria</h2><p>Gerado em: ' + new Date().toLocaleString() + '</p><table><thead><tr><th>Data</th><th>Usuário</th><th>Ação</th><th>Detalhes</th></tr></thead><tbody>' + tableContent + '</tbody></table></body></html>');
            printWindow.document.close(); 
        }

        window.clearAuditLogs = async () => {
            const term = document.getElementById('audit-search').value.toLowerCase();
            const logsToDelete = allAuditLogs.filter(l => (l.userEmail && l.userEmail.toLowerCase().includes(term)) || (l.action && l.action.toLowerCase().includes(term)) || (l.details && l.details.toLowerCase().includes(term)));
            if(logsToDelete.length === 0) return alert("Nenhum registro encontrado para excluir.");
            const msg = term ? `Tem certeza que deseja excluir os ${logsToDelete.length} registros encontrados para "${term}"?` : `Tem certeza que deseja excluir TODOS os ${logsToDelete.length} registros?`;
            if(!confirm(msg)) return;
            const verify = prompt("Para confirmar, digite: DELETAR"); if(verify !== "DELETAR") return alert("Ação cancelada.");
            const batch = writeBatch(db); logsToDelete.forEach(log => { const ref = doc(db, "audit_logs", log.id); batch.delete(ref); });
            await batch.commit(); alert("Registros excluídos."); renderAuditLogs();
        }

        async function populateUserSelect() {
            const select = document.getElementById('select-user-permission'); select.innerHTML = '<option value="">Carregando...</option>';
            try {
                const snap = await getDocs(collection(db, "users")); select.innerHTML = '<option value="">Selecione um usuário...</option>';
                snap.forEach(doc => { const u = doc.data(); const opt = document.createElement('option'); opt.value = doc.id; opt.text = `${u.email} (${u.role})`; select.appendChild(opt); });
            } catch(e) { console.error("Erro populate", e); }
        }

        window.loadUserPermissions = async () => {
            const uid = document.getElementById('select-user-permission').value; const container = document.getElementById('permissions-container');
            if(!uid) { container.style.display = 'none'; return; } container.style.display = 'block';
            try {
                const userRef = doc(db, "users", uid); const userSnap = await getDoc(userRef);
                if(userSnap.exists()) {
                    const p = userSnap.data().permissions || {};
                    
                    document.getElementById('perm-tap').checked = p.access_tap !== false; 
                    
                    // Box TAP Sub-menus
                    document.getElementById('perm-menu-termo').checked = p.access_menu_termo !== false;
                    document.getElementById('perm-menu-prof').checked = p.access_menu_prof !== false;
                    document.getElementById('perm-menu-contratante').checked = p.access_menu_contratante !== false;
                    document.getElementById('perm-menu-dados-obra').checked = p.access_menu_dados_obra !== false;

                    // Box TAP Listas
                    document.getElementById('perm-list-termo').checked = p.access_list_termo !== false;
                    document.getElementById('perm-list-prof').checked = p.access_list_prof !== false;
                    document.getElementById('perm-list-contratante').checked = p.access_list_contratante !== false;
                    document.getElementById('perm-list-tap').checked = p.access_list_tap !== false;

                    document.getElementById('perm-diaries').checked = p.access_diaries !== false; 

                    // Box Diários Sub-menus
                    document.getElementById('perm-menu-diario').checked = p.access_menu_diario !== false;
                    document.getElementById('perm-menu-occ').checked = p.access_menu_occ !== false;
                    
                    // Box Diários Listas
                    document.getElementById('perm-list-diario').checked = p.access_list_diario !== false;
                    document.getElementById('perm-list-occ').checked = p.access_list_occ !== false;

                    document.getElementById('perm-management').checked = p.access_management !== false; 
                    document.getElementById('perm-query').checked = p.access_query !== false; 
                    document.getElementById('perm-communication').checked = p.access_communication !== false; 
                    document.getElementById('perm-employees').checked = p.access_employees !== false; 
                    document.getElementById('perm-warehouse').checked = p.access_warehouse !== false; 
                    document.getElementById('perm-settings').checked = p.access_settings === true; 
                    document.getElementById('perm-edit-reports').checked = p.can_edit_reports === true;
                }
            } catch(e) { console.error(e); }
        };

        window.savePermissions = async () => {
            const uid = document.getElementById('select-user-permission').value; if(!uid) return alert("Selecione um usuário primeiro!");
            try {
                const perms = { 
                    access_tap: document.getElementById('perm-tap').checked, 
                    
                    access_menu_termo: document.getElementById('perm-menu-termo').checked,
                    access_menu_prof: document.getElementById('perm-menu-prof').checked,
                    access_menu_contratante: document.getElementById('perm-menu-contratante').checked,
                    access_menu_dados_obra: document.getElementById('perm-menu-dados-obra').checked,
                    
                    access_list_termo: document.getElementById('perm-list-termo').checked,
                    access_list_prof: document.getElementById('perm-list-prof').checked,
                    access_list_contratante: document.getElementById('perm-list-contratante').checked,
                    access_list_tap: document.getElementById('perm-list-tap').checked,

                    access_diaries: document.getElementById('perm-diaries').checked, 
                    
                    access_menu_diario: document.getElementById('perm-menu-diario').checked,
                    access_menu_occ: document.getElementById('perm-menu-occ').checked,
                    
                    access_list_diario: document.getElementById('perm-list-diario').checked,
                    access_list_occ: document.getElementById('perm-list-occ').checked,

                    access_management: document.getElementById('perm-management').checked, 
                    access_query: document.getElementById('perm-query').checked, 
                    access_communication: document.getElementById('perm-communication').checked, 
                    access_employees: document.getElementById('perm-employees').checked, 
                    access_warehouse: document.getElementById('perm-warehouse').checked, 
                    access_settings: document.getElementById('perm-settings').checked, 
                    can_edit_reports: document.getElementById('perm-edit-reports').checked
                };
                await updateDoc(doc(db, "users", uid), { permissions: perms }); await logAction("Alteração Permissão", `ID Usuário: ${uid}`); alert("Permissões atualizadas com sucesso!");
            } catch (e) { console.error("Erro ao salvar permissões:", e); alert("Erro ao salvar no banco de dados."); }
        };

        window.backupData = async () => { const s = await getDocs(collection(db, "users")); let d=[]; s.forEach(x=>d.push(x.data())); const blob = new Blob([JSON.stringify(d)], {type:"application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "backup.json"; a.click(); };
        window.resetData = async () => { if(!confirm("APAGAR TUDO (Exceto você)?")) return; const s = await getDocs(collection(db, "users")); const b = writeBatch(db); s.forEach(x => { if(x.id !== currentUser.id) b.delete(doc(db, "users", x.id)); }); await b.commit(); alert("Feito."); };
        window.toggleSubmenu = (el) => { const list = el.nextElementSibling; list.classList.toggle('open'); el.querySelector('.arrow').style.transform = list.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; };
    </script>
</body>
</html>